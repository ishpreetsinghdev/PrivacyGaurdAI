<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PrivacyGuard AI - Local Security Scanner</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --bg-page: #FAFBFC;
            --bg-card: #FFFFFF;
            --bg-card-hover: #F6F8FA;
            --text-primary: #1A202C;
            --text-secondary: #1f2c42;
            --text-muted: #000000;
            --border-subtle: #DFE5ED;
            --border-strong: #C4CEE0;
            --accent: #2D5017;
            --accent-hover: #21380D;
            --accent-light: #4A7C1C;
            --success: #047857;
            --success-light: #D1F0E4;
            --warning: #B45309;
            --warning-light: #FEF0E6;
            --danger: #991B1B;
            --danger-light: #991B1B;
            --gradient-start: #2D5017;
            --gradient-end: #047857;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.08);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.08);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.12), 0 4px 6px -4px rgb(0 0 0 / 0.08);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.15), 0 8px 10px -6px rgb(0 0 0 / 0.08);
        }

        [data-theme="dark"] {
            /* Sophisticated Dark Mode Palette (Zinc/Neutral based) */
            --bg-page: #09090b; /* Zinc 950 */
            --bg-card: #18181b; /* Zinc 900 */
            --bg-card-hover: #27272a; /* Zinc 800 */
            
            --text-primary: #f4f4f5; /* Zinc 50 */
            --text-secondary: #a1a1aa; /* Zinc 400 */
            --text-muted: #52525b; /* Zinc 600 */
            
            --border-subtle: #27272a; /* Zinc 800 */
            --border-strong: #3f3f46; /* Zinc 700 */
            
            /* Professional Green Accent */
            --accent: #22c55e; /* Green 500 */
            --accent-hover: #16a34a; /* Green 600 */
            --accent-light: rgba(34, 197, 94, 0.15);
            
            /* Semantic Colors - Muted for dark mode to reduce eye strain */
            --success: #22c55e;
            --success-light: rgba(34, 197, 94, 0.1);
            
            --warning: #fbbf24; /* Amber 400 */
            --warning-light: rgba(251, 191, 36, 0.1);
            
            --danger: #f87171; /* Red 400 */
            --danger-light: rgba(248, 113, 113, 0.1);
            
            --gradient-start: #22c55e;
            --gradient-end: #10b981;
            
            /* Smoother, deeper shadows for dark mode */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5), 0 2px 4px -2px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -4px rgba(0, 0, 0, 0.5);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.5), 0 8px 10px -6px rgba(0, 0, 0, 0.5);
        }

        /* Specific Comparison Mode Dark Fixes */
        [data-theme="dark"] #comparison-output {
            background-color: #0f0f10 !important;
            border-color: #22c55e !important;
            color: #d1d5db !important;
            background-image: none !important;
        }
        
        [data-theme="dark"] .result-card {
            background: #18181b !important;
            border-color: #27272a !important;
        }

        * { 
            transition: background-color 0.25s ease, border-color 0.25s ease, color 0.2s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-page);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Dark mode comprehensive overrides */
        [data-theme="dark"] .bg-white { background-color: var(--bg-card) !important; }
        [data-theme="dark"] .bg-\[\#F7F7F5\] { background-color: var(--bg-page) !important; }
        [data-theme="dark"] .bg-\[\#F8FAFC\] { background-color: var(--bg-page) !important; }
        [data-theme="dark"] .bg-gray-50 { background-color: #141414 !important; }
        [data-theme="dark"] .bg-gray-100 { background-color: #1c1c1e !important; }
        [data-theme="dark"] .bg-gray-200 { background-color: #2c2c2e !important; }
        [data-theme="dark"] .text-gray-900 { color: #FFFFFF !important; }
        [data-theme="dark"] .text-gray-800 { color: #F1F5F9 !important; }
        [data-theme="dark"] .text-gray-700 { color: #E2E8F0 !important; }
        [data-theme="dark"] .text-gray-600 { color: #CBD5E1 !important; }
        [data-theme="dark"] .text-gray-500 { color: #A1A1AA !important; }
        [data-theme="dark"] .text-gray-400 { color: #64748B !important; }
        [data-theme="dark"] .border-gray-200 { border-color: #27272A !important; }
        [data-theme="dark"] .border-gray-100 { border-color: #1F1F23 !important; }
        [data-theme="dark"] .border-\[\#E9E9E7\] { border-color: #27272A !important; }
        [data-theme="dark"] .border-\[\#E2E8F0\] { border-color: #27272A !important; }
        [data-theme="dark"] .hover\:bg-gray-50:hover { background-color: #27272A !important; }
        [data-theme="dark"] .hover\:bg-gray-100:hover { background-color: #2c2c2e !important; }
        
        [data-theme="dark"] input, [data-theme="dark"] textarea, [data-theme="dark"] select { 
            background-color: #0F0F10 !important; 
            color: var(--text-primary) !important;
            border-color: #27272A !important;
        }
        [data-theme="dark"] input:focus, [data-theme="dark"] textarea:focus, [data-theme="dark"] select:focus { 
            border-color: #22C55E !important;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.15) !important;
        }
        [data-theme="dark"] input::placeholder, [data-theme="dark"] textarea::placeholder { 
            color: #52525B !important;
        }
        
        [data-theme="dark"] .onboarding-card { 
            background: linear-gradient(180deg, #1c1c1e 0%, #141414 100%);
            border: 1px solid #27272A;
        }
        [data-theme="dark"] .pattern-wizard { 
            background: linear-gradient(180deg, #1c1c1e 0%, #141414 100%);
            border: 1px solid #27272A;
        }
        [data-theme="dark"] .shortcuts-panel { 
            background: linear-gradient(180deg, #1c1c1e 0%, #141414 100%);
            border: 1px solid #27272A;
        }
        
        /* Dark mode special colors */
        [data-theme="dark"] .bg-green-50 { background-color: #052E16 !important; }
        [data-theme="dark"] .bg-green-100 { background-color: #064E3B !important; }
        [data-theme="dark"] .bg-red-50 { background-color: #450A0A !important; }
        [data-theme="dark"] .bg-red-100 { background-color: #7F1D1D !important; }
        [data-theme="dark"] .bg-yellow-50 { background-color: #422006 !important; }
        [data-theme="dark"] .bg-yellow-100 { background-color: #713F12 !important; }
        [data-theme="dark"] .bg-blue-50 { background-color: #172554 !important; }
        [data-theme="dark"] .bg-blue-100 { background-color: #1E3A8A !important; }
        [data-theme="dark"] .bg-purple-50 { background-color: #2E1065 !important; }
        [data-theme="dark"] .bg-purple-100 { background-color: #4C1D95 !important; }
        [data-theme="dark"] .bg-orange-50 { background-color: #431407 !important; }
        [data-theme="dark"] .bg-orange-100 { background-color: #7C2D12 !important; }
        [data-theme="dark"] .bg-pink-50 { background-color: #500724 !important; }
        [data-theme="dark"] .bg-pink-100 { background-color: #831843 !important; }
        [data-theme="dark"] .bg-violet-100 { background-color: #4C1D95 !important; }
        [data-theme="dark"] .bg-cyan-100 { background-color: #164E63 !important; }
        [data-theme="dark"] .bg-amber-100 { background-color: #78350F !important; }
        [data-theme="dark"] .bg-emerald-100 { background-color: #064E3B !important; }
        [data-theme="dark"] .bg-rose-100 { background-color: #881337 !important; }
        
        /* Dark mode text colors for colored backgrounds */
        [data-theme="dark"] .text-green-800 { color: #86EFAC !important; }
        [data-theme="dark"] .text-green-700 { color: #4ADE80 !important; }
        [data-theme="dark"] .text-green-600 { color: #22C55E !important; }
        [data-theme="dark"] .text-red-700 { color: #FCA5A5 !important; }
        [data-theme="dark"] .text-yellow-700 { color: #FCD34D !important; }
        [data-theme="dark"] .text-blue-900 { color: #93C5FD !important; }
        [data-theme="dark"] .text-purple-900 { color: #C4B5FD !important; }
        
        /* =============================================
           GLASS CARD & PROFESSIONAL STYLING
           ============================================= */
        
        .glass-card {
            background: #FFFFFF;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #DFE5ED;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
        }
        [data-theme="dark"] .glass-card {
            background: rgba(20, 20, 21, 0.8);
            border: 1px solid rgba(34, 197, 94, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        
        .result-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        [data-theme="dark"] .result-card {
            background: #141415;
            border-color: rgba(34, 197, 94, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .confidence-high {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(34, 197, 94, 0.15);
            color: #16A34A;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        [data-theme="dark"] .confidence-high {
            background: rgba(34, 197, 94, 0.2);
            color: #86EFAC;
        }
        
        .confidence-medium {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(251, 191, 36, 0.15);
            color: #D97706;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        [data-theme="dark"] .confidence-medium {
            background: rgba(251, 191, 36, 0.15);
            color: #FBBF24;
        }
        
        .confidence-low {
            display: inline-block;
            padding: 4px 10px;
            background: rgba(107, 114, 128, 0.15);
            color: #6B7280;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.5px;
            border: 1px solid rgba(107, 114, 128, 0.3);
        }
        [data-theme="dark"] .confidence-low {
            background: rgba(107, 114, 128, 0.2);
            color: #D1D5DB;
        }
        
        .category-section {
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        .category-header {
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .category-header:hover {
            background: var(--bg-page) !important;
        }
        
        [data-theme="dark"] .category-header:hover {
            background: rgba(34, 197, 94, 0.08) !important;
        }
        
        .category-body {
            background: var(--bg-card);
        }
        
        .category-toggle {
            transition: transform 0.3s ease;
        }
        
        .category-section.collapsed .category-toggle {
            transform: rotate(-90deg);
        }
        
        .category-pii { border-left: 4px solid rgba(239, 68, 68, 0.6); }
        [data-theme="dark"] .category-pii { border-left-color: rgba(248, 113, 113, 0.4); }
        
        .category-credentials { border-left: 4px solid rgba(168, 85, 247, 0.6); }
        [data-theme="dark"] .category-credentials { border-left-color: rgba(196, 181, 253, 0.4); }
        
        .category-scam { border-left: 4px solid rgba(251, 191, 36, 0.6); }
        [data-theme="dark"] .category-scam { border-left-color: rgba(251, 191, 36, 0.4); }
        
        .category-corporate { border-left: 4px solid rgba(59, 130, 246, 0.6); }
        [data-theme="dark"] .category-corporate { border-left-color: rgba(147, 197, 253, 0.4); }
        
        .category-compliance { border-left: 4px solid rgba(249, 115, 22, 0.6); }
        [data-theme="dark"] .category-compliance { border-left-color: rgba(254, 215, 170, 0.4); }
        
        .category-pii .category-header { background: rgba(239, 68, 68, 0.08); }
        [data-theme="dark"] .category-pii .category-header { background: rgba(239, 68, 68, 0.1); }
        
        .category-credentials .category-header { background: rgba(168, 85, 247, 0.08); }
        [data-theme="dark"] .category-credentials .category-header { background: rgba(168, 85, 247, 0.1); }
        
        .category-scam .category-header { background: rgba(251, 191, 36, 0.08); }
        [data-theme="dark"] .category-scam .category-header { background: rgba(251, 191, 36, 0.1); }
        
        .category-corporate .category-header { background: rgba(59, 130, 246, 0.08); }
        [data-theme="dark"] .category-corporate .category-header { background: rgba(59, 130, 246, 0.1); }
        
        .category-compliance .category-header { background: rgba(249, 115, 22, 0.08); }
        [data-theme="dark"] .category-compliance .category-header { background: rgba(249, 115, 22, 0.1); }
        
        .finding-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            transition: all 0.2s ease;
        }
        [data-theme="dark"] .finding-item {
            border-bottom-color: rgba(255, 255, 255, 0.05);
        }
        
        .finding-item:hover {
            background: rgba(34, 197, 94, 0.04);
        }
        [data-theme="dark"] .finding-item:hover {
            background: rgba(34, 197, 94, 0.08);
        }
        
        .finding-item:last-child {
            border-bottom: none;
        }
        
        .finding-value {
            background: rgba(107, 114, 128, 0.1);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: 'Monaco', 'Courier New', monospace;
            word-break: break-all;
            margin-top: 6px;
            max-height: 120px;
            overflow-y: auto;
        }
        [data-theme="dark"] .finding-value {
            background: rgba(107, 114, 128, 0.15);
        }
        
        .btn-whitelist {
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .btn-whitelist:hover {
            color: #16A34A;
            background: rgba(34, 197, 94, 0.1);
        }
        [data-theme="dark"] .btn-whitelist:hover {
            background: rgba(34, 197, 94, 0.15);
        }
        
        /* =============================================
           DARK MODE COLOR DEFINITIONS
           ============================================= */
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .opacity-75 {
            opacity: 0.75;
        }
        
        .bg-opacity-5 {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        /* Dark mode gradients */
        [data-theme="dark"] .from-gray-50 { --tw-gradient-from: #141414 !important; }
        [data-theme="dark"] .to-white { --tw-gradient-to: #18181B !important; }
        [data-theme="dark"] .from-gray-900 { --tw-gradient-from: #FAFAFA !important; }
        [data-theme="dark"] .to-gray-600 { --tw-gradient-to: #A1A1AA !important; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #CBD5E1 0%, #94A3B8 100%);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, #94A3B8 0%, #64748B 100%);
            background-clip: content-box;
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #3F3F46 0%, #27272A 100%);
            background-clip: content-box;
        }
        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover { 
            background: linear-gradient(180deg, #52525B 0%, #3F3F46 100%);
            background-clip: content-box;
        }
        
        /* Selection */
        ::selection {
            background: rgba(34, 197, 94, 0.2);
            color: inherit;
        }
        [data-theme="dark"] ::selection {
            background: rgba(34, 197, 94, 0.3);
        }
        
        /* =============================================
           ENHANCED ANIMATIONS
           ============================================= */
        
        @keyframes categorySlide {
            from { opacity: 0; max-height: 0; transform: translateY(-10px); }
            to { opacity: 1; max-height: 1000px; transform: translateY(0); }
        }
        
        @keyframes categoryCollapse {
            from { opacity: 1; max-height: 1000px; transform: translateY(0); }
            to { opacity: 0; max-height: 0; transform: translateY(-10px); }
        }
        
        .category-body {
            animation: categorySlide 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        .category-section.collapsed .category-body {
            animation: categoryCollapse 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* Finding item stagger animation */
        @keyframes findingFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .finding-item {
            animation: findingFadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        /* Animations */
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .scale-in { animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .float { animation: float 3s ease-in-out infinite; }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Navigation */
        .nav-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
        }
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--accent) 0%, var(--accent-light) 100%);
            border-radius: 0 3px 3px 0;
            transition: height 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.2s;
            opacity: 0;
        }
        .nav-item.active::before { 
            opacity: 1;
            height: 60%;
        }
        .nav-item.active {
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.08) 0%, transparent 100%);
            font-weight: 600;
            color: #0F172A;
        }
        .nav-item::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(15, 23, 42, 0.04) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }
        .nav-item:hover::after { opacity: 1; }
        .nav-item:hover { 
            background: var(--bg-card-hover) !important;
            color: var(--text-primary) !important;
            transform: translateX(4px);
        }
        [data-theme="dark"] .nav-item:hover {
            background: rgba(34, 197, 94, 0.08) !important;
            color: #E4E4E7 !important;
        }
        [data-theme="dark"] .nav-item.active {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, transparent 100%);
            color: #22C55E;
        }
        [data-theme="dark"] .nav-item::after {
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.08) 0%, transparent 100%);
        }
        [data-theme="dark"] .nav-item.active::before { 
            background: linear-gradient(180deg, #22C55E 0%, #16A34A 100%);
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        .card::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 1px;
            background: linear-gradient(135deg, #F6F8FA 0%, #FFFFFF 50%, #F9FAFC 100%);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }
        .card:hover {
            box-shadow: 0 20px 40px -12px rgba(0,0,0,0.12), 0 8px 20px -8px rgba(0,0,0,0.08);
            transform: translateY(-4px);
        }
        [data-theme="dark"] .card::before {
            background: linear-gradient(135deg, rgba(255,255,255,0.06) 0%, transparent 50%, rgba(0,0,0,0.1) 100%);
        }
        [data-theme="dark"] .card:hover { 
            box-shadow: 0 20px 40px -12px rgba(0,0,0,0.5), 0 8px 20px -8px rgba(0,0,0,0.4);
        }

        .stat-card {
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .stat-card:hover::after { transform: scaleX(1); }
        
        /* Glass morphism */
        .glass-card {
            background: #FFFFFF;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #DFE5ED;
        }
        [data-theme="dark"] .glass-card {
            background: rgba(24, 24, 27, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #2D5017 0%, #21380D 100%);
            color: #FFFFFF;
            font-weight: 600;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 14px 0 rgba(45, 80, 23, 0.25), inset 0 1px 0 rgba(255,255,255,0.1);
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-primary:hover::before { left: 100%; }
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px -4px rgba(45, 80, 23, 0.35), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        .btn-primary:active { 
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(45, 80, 23, 0.2), inset 0 1px 2px rgba(0,0,0,0.1);
        }

        [data-theme="dark"] .btn-primary { 
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
            box-shadow: 0 4px 14px 0 rgba(34, 197, 94, 0.35), inset 0 1px 0 rgba(255,255,255,0.15);
        }
        [data-theme="dark"] .btn-primary:hover {
            box-shadow: 0 8px 25px -4px rgba(34, 197, 94, 0.45), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        
        /* Secondary button */
        .btn-secondary {
            background: #FFFFFF;
            color: #1A202C;
            font-weight: 500;
            border-radius: 12px;
            border: 1px solid #DFE5ED;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            transition: all 0.2s ease;
        }
        .btn-secondary:hover {
            background: #F6F8FA;
            border-color: #C4CEE0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .btn-secondary {
            background: #27272A;
            color: #FAFAFA;
            border-color: #3F3F46;
        }
        [data-theme="dark"] .btn-secondary:hover {
            background: #3F3F46;
            border-color: #52525B;
        }

        /* Risk highlighting */
        .highlight-risk {
            background: linear-gradient(135deg, #FCE8E8 0%, #F5D5D5 100%);
            border-bottom: 2px solid #991B1B;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 500;
            color: #7F1D1D;
        }
        .highlight-warning {
            background: linear-gradient(135deg, #FEF0E6 0%, #FDE4CC 100%);
            border-bottom: 2px solid #B45309;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: 500;
            color: #92400E;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            right: -480px;
            top: 0;
            bottom: 0;
            width: 480px;
            background: var(--bg-card);
            box-shadow: -10px 0 50px rgba(0,0,0,0.15);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            overflow-y: auto;
        }
        .settings-panel.open { right: 0; }
        
        .settings-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 99;
        }
        .settings-backdrop.open { opacity: 1; pointer-events: all; }

        /* Toggle Switch */
        .toggle-switch {
            appearance: none;
            width: 52px;
            height: 28px;
            background: linear-gradient(135deg, #DFE5ED 0%, #C4CEE0 100%);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.06), inset 0 -1px 2px rgba(255,255,255,0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .toggle-switch:checked { 
            background: linear-gradient(135deg, #2D5017 0%, #21380D 100%);
            box-shadow: 0 0 20px rgba(45, 80, 23, 0.35), inset 0 2px 4px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .toggle-switch { 
            background: linear-gradient(135deg, #3F3F46 0%, #27272A 100%);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }
        [data-theme="dark"] .toggle-switch:checked {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
        }
        .toggle-switch::before {
            content: '';
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(180deg, #FFFFFF 0%, #F1F5F9 100%);
            top: 2px;
            left: 2px;
            transition: transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1);
        }
        .toggle-switch:checked::before { 
            transform: translateX(24px);
            background: linear-gradient(180deg, #FFFFFF 0%, #F1F5F9 100%);
        }
        .toggle-switch:hover::before {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Confidence badges */
        .confidence-high { 
            background: linear-gradient(135deg, #FCE8E8 0%, #F5D5D5 100%);
            color: #991B1B;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(153, 27, 27, 0.15), inset 0 1px 0 rgba(255,255,255,0.6);
            border: 1px solid rgba(153, 27, 27, 0.2);
        }
        .confidence-medium { 
            background: linear-gradient(135deg, #FEF0E6 0%, #FDE4CC 100%);
            color: #B45309;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(180, 83, 9, 0.15), inset 0 1px 0 rgba(255,255,255,0.6);
            border: 1px solid rgba(180, 83, 9, 0.2);
        }
        .confidence-low { 
            background: linear-gradient(135deg, #E8F0F8 0%, #D5E4F0 100%);
            color: #1E40AF;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(30, 64, 175, 0.15), inset 0 1px 0 rgba(255,255,255,0.6);
            border: 1px solid rgba(30, 64, 175, 0.2);
        }
        
        [data-theme="dark"] .confidence-high {
            background: linear-gradient(135deg, #7F1D1D 0%, #991B1B 100%);
            color: #FCA5A5;
            border-color: rgba(248,113,113,0.2);
        }
        [data-theme="dark"] .confidence-medium {
            background: linear-gradient(135deg, #78350F 0%, #92400E 100%);
            color: #FCD34D;
            border-color: rgba(252,211,77,0.2);
        }
        [data-theme="dark"] .confidence-low {
            background: linear-gradient(135deg, #312E81 0%, #3730A3 100%);
            color: #A5B4FC;
            border-color: rgba(165,180,252,0.2);
        }

        /* Category sections */
        .category-section { 
            border-left: 4px solid #E5E7EB;
            border-radius: 0 12px 12px 0;
            overflow: hidden;
            transition: border-color 0.2s;
        }
        .category-section:hover { border-left-color: #9CA3AF; }
        .category-section.collapsed .category-body { display: none; }
        .category-toggle { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .category-section.collapsed .category-toggle { transform: rotate(-90deg); }

        /* Modals */
        .shortcuts-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-card);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.3);
            padding: 28px;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            min-width: 420px;
            border: 1px solid var(--border-subtle);
        }
        .shortcuts-panel.active { 
            opacity: 1; 
            pointer-events: all; 
            transform: translate(-50%, -50%) scale(1); 
        }

        .onboarding-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.7) 100%);
            backdrop-filter: blur(8px);
            z-index: 300;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }
        .onboarding-overlay.active { opacity: 1; pointer-events: all; }
        .onboarding-card {
            background: linear-gradient(180deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 24px;
            padding: 48px;
            max-width: 520px;
            text-align: center;
            box-shadow: 0 30px 100px rgba(0,0,0,0.4);
            animation: scaleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        [data-theme="dark"] .onboarding-card { background: linear-gradient(180deg, #1f1f1f 0%, #141414 100%); }

        /* Real-time indicator */
        .realtime-indicator {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 12px 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 16px;
            opacity: 0;
            pointer-events: none;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
        }
        .realtime-indicator.active { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0);
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 12px;
            height: 12px;
            top: -20px;
            animation: confetti-fall 3.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
            z-index: 1000;
            pointer-events: none;
            border-radius: 2px;
        }
        @keyframes confetti-fall {
            0% { transform: translateY(0) rotate(0deg) scale(1); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg) scale(0.5); opacity: 0; }
        }

        /* Pattern wizard */
        .pattern-wizard-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(6px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .pattern-wizard-overlay.active { opacity: 1; pointer-events: all; }
        .pattern-wizard {
            background: var(--bg-card);
            border-radius: 20px;
            width: 90%;
            max-width: 580px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 30px 100px rgba(0,0,0,0.4);
            animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }
        [data-theme="dark"] .skeleton {
            background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%);
            background-size: 200% 100%;
        }

        /* Mobile backdrop */
        .mobile-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 40;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .mobile-backdrop.active { opacity: 1; pointer-events: all; }

        /* Quick action buttons */
        .quick-action {
            border: 2px dashed #DFE5ED;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .quick-action::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(45, 80, 23, 0.08) 0%, rgba(4, 120, 87, 0.08) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .quick-action:hover::before { opacity: 1; }
        .quick-action:hover {
            border-color: #2D5017;
            border-style: solid;
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 40px -12px rgba(45, 80, 23, 0.25), 0 8px 16px rgba(0,0,0,0.06);
        }
        .quick-action:hover i { 
            transform: scale(1.15) rotate(-5deg); 
        }
        .quick-action:active {
            transform: translateY(-2px) scale(1);
        }
        [data-theme="dark"] .quick-action { 
            border-color: #3F3F46;
            background: rgba(24, 24, 27, 0.5);
        }
        [data-theme="dark"] .quick-action::before {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(16, 185, 129, 0.08) 100%);
        }
        [data-theme="dark"] .quick-action:hover { 
            border-color: #22C55E;
            box-shadow: 0 20px 40px -12px rgba(34, 197, 94, 0.3), 0 8px 16px rgba(0,0,0,0.2);
        }

        /* Keyboard shortcuts */
        kbd {
            background: linear-gradient(180deg, #F6F8FA 0%, #DFE5ED 100%);
            border: 1px solid #C4CEE0;
            border-radius: 6px;
            padding: 3px 8px;
            font-family: 'SF Mono', Monaco, Consolas, monospace;
            font-size: 11px;
            box-shadow: 0 2px 0 #C4CEE0;
            color: #1A202C;
        }
        [data-theme="dark"] kbd {
            background: linear-gradient(180deg, #374151 0%, #1f2937 100%);
            border-color: #4b5563;
            box-shadow: 0 2px 0 #1f2937;
            color: #e5e7eb;
        }

        /* Score display */
        .score-display {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .score-ring {
            position: absolute;
            inset: -4px;
            border-radius: 50%;
            border: 3px solid transparent;
            animation: score-pulse 2s ease-in-out infinite;
        }
        @keyframes score-pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        /* Toast notifications */
        .toast {
            animation: toastIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        @keyframes toastIn {
            from { 
                transform: translateX(100px) scale(0.9); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0) scale(1); 
                opacity: 1; 
            }
        }
        
        .toast-success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(22, 163, 74, 0.95) 100%);
            box-shadow: 0 10px 40px -10px rgba(34, 197, 94, 0.5), 0 4px 12px rgba(0,0,0,0.1);
        }
        .toast-error {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(220, 38, 38, 0.95) 100%);
            box-shadow: 0 10px 40px -10px rgba(239, 68, 68, 0.5), 0 4px 12px rgba(0,0,0,0.1);
        }
        .toast-info {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.95) 0%, rgba(30, 41, 59, 0.95) 100%);
            box-shadow: 0 10px 40px -10px rgba(15, 23, 42, 0.5), 0 4px 12px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .toast-info {
            background: linear-gradient(135deg, rgba(39, 39, 42, 0.95) 0%, rgba(63, 63, 70, 0.95) 100%);
        }

        /* Input focus */
        textarea:focus, input[type="text"]:focus, input[type="range"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }
        [data-theme="dark"] textarea:focus, 
        [data-theme="dark"] input[type="text"]:focus {
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        /* Preset buttons */
        .preset-btn {
            position: relative;
            overflow: hidden;
        }
        .preset-btn::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .preset-btn:hover::after { opacity: 1; }
        .preset-btn.active {
            border-color: var(--accent) !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        [data-theme="dark"] .preset-btn.active { 
            border-color: #10B981 !important; 
            box-shadow: 0 4px 15px rgba(16,185,129,0.2);
        }

        /* Empty state illustration */
        .empty-state {
            animation: float 3s ease-in-out infinite;
        }

        /* Result card */
        .result-card {
            position: relative;
            overflow: hidden;
        }
        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }
        .result-card.safe::before { background: linear-gradient(90deg, #10B981, #34D399); }
        .result-card.warning::before { background: linear-gradient(90deg, #F59E0B, #FBBF24); }
        .result-card.danger::before { background: linear-gradient(90deg, #EF4444, #F87171); }

        /* Animate on hover */
        .hover-lift { transition: transform 0.2s, box-shadow 0.2s; }
        .hover-lift:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }

        /* Glass effect */
        .glass {
            background: rgba(255,255,255,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
        }
        [data-theme="dark"] .glass {
            background: rgba(26,26,26,0.8);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        /* =============================================
           DARK MODE SIDEBAR & LAYOUT FIXES
           ============================================= */
        [data-theme="dark"] aside {
            background: var(--bg-page) !important;
            border-color: var(--border-subtle) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] aside .border-gray-200,
        [data-theme="dark"] aside .border-\[\#E9E9E7\] {
            border-color: var(--border-subtle) !important;
        }
        
        [data-theme="dark"] aside .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] aside .text-gray-900 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] aside .text-gray-400 {
            color: var(--text-muted) !important;
        }
        
        [data-theme="dark"] aside .hover\:text-gray-900:hover {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] aside .hover\:bg-\[\#E3E2E0\]:hover {
            background: rgba(34, 197, 94, 0.08) !important;
        }
        
        [data-theme="dark"] aside .bg-\[\#E3E2E0\] {
            background: rgba(34, 197, 94, 0.08) !important;
        }
        
        [data-theme="dark"] aside .bg-gray-50 {
            background: var(--bg-card) !important;
        }
        
        [data-theme="dark"] aside .bg-gray-100 {
            background: var(--bg-card-hover) !important;
        }
        
        [data-theme="dark"] main {
            background: var(--bg-page) !important;
        }
        
        [data-theme="dark"] header {
            background: var(--bg-card) !important;
            border-color: var(--border-subtle) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] header .text-gray-600 {
            color: var(--text-secondary) !important;
        }
        
        /* =============================================
           SETTINGS PANEL DARK MODE
           ============================================= */
        [data-theme="dark"] .settings-panel {
            background: var(--bg-card) !important;
            border-left: 1px solid var(--border-subtle);
            box-shadow: -10px 0 50px rgba(0,0,0,0.3) !important;
        }
        
        [data-theme="dark"] .settings-panel .border-gray-200 {
            border-color: var(--border-subtle) !important;
        }
        
        [data-theme="dark"] .settings-panel h3,
        [data-theme="dark"] .settings-panel .font-semibold {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .settings-panel .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .settings-panel .bg-gray-50 {
            background: var(--bg-card-hover) !important;
        }
        
        [data-theme="dark"] .settings-panel .hover\:bg-gray-100:hover {
            background: var(--bg-card-hover) !important;
        }
        
        [data-theme="dark"] .settings-panel .bg-red-50 {
            background: rgba(239, 68, 68, 0.08) !important;
        }
        
        [data-theme="dark"] .settings-panel .hover\:bg-red-100:hover {
            background: rgba(239, 68, 68, 0.15) !important;
        }
        
        [data-theme="dark"] .settings-panel select {
            background: var(--bg-card-hover) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-subtle) !important;
        }
        
        /* =============================================
           TOGGLE SWITCH DARK MODE
           ============================================= */
        [data-theme="dark"] .toggle-switch {
            background: linear-gradient(135deg, #3F3F46 0%, #27272A 100%) !important;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3) !important;
        }
        
        [data-theme="dark"] .toggle-switch:checked {
            background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.35), inset 0 2px 4px rgba(0,0,0,0.1) !important;
        }
        
        [data-theme="dark"] .toggle-switch::before {
            background: linear-gradient(180deg, #E4E4E7 0%, #D4D4D8 100%) !important;
        }
        
        [data-theme="dark"] .toggle-switch:checked::before {
            background: linear-gradient(180deg, #FAFAFA 0%, #F1F5F9 100%) !important;
        }
        
        /* =============================================
           KEYBOARD SHORTCUTS DARK MODE
           ============================================= */
        [data-theme="dark"] .shortcuts-panel {
            background: var(--bg-card) !important;
            border-color: var(--border-subtle) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .shortcuts-panel h3 {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .shortcuts-panel .text-sm {
            color: var(--text-secondary) !important;
        }
        
        /* =============================================
           ONBOARDING & MODALS DARK MODE
           ============================================= */
        [data-theme="dark"] .onboarding-card {
            background: linear-gradient(180deg, #1F1F23 0%, #141414 100%) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .pattern-wizard {
            background: var(--bg-card) !important;
            border-color: var(--border-subtle) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .pattern-wizard .border-gray-200 {
            border-color: var(--border-subtle) !important;
        }
        
        [data-theme="dark"] .pattern-wizard h3 {
            color: var(--text-primary) !important;
        }
        
        /* =============================================
           TOAST NOTIFICATIONS DARK MODE
           ============================================= */
        [data-theme="dark"] .toast {
            color: #FAFAFA !important;
        }
        
        /* =============================================
           BUTTONS IN MODALS DARK MODE
           ============================================= */
        [data-theme="dark"] .hover\:bg-gray-100:hover {
            background: var(--bg-card-hover) !important;
        }
        
        [data-theme="dark"] .bg-gray-100 {
            background: var(--bg-card-hover) !important;
        }
        
        /* =============================================
           REAL-TIME INDICATOR DARK MODE
           ============================================= */
        [data-theme="dark"] .realtime-indicator {
            background: var(--bg-card) !important;
            border-color: var(--border-subtle) !important;
            color: var(--text-primary) !important;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3) !important;
        }
        
        [data-theme="dark"] .realtime-indicator .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        
        [data-theme="dark"] .realtime-indicator .text-gray-400 {
            color: var(--text-muted) !important;
        }
        
        [data-theme="dark"] #risk-score-live {
            color: var(--text-primary) !important;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Mobile Backdrop -->
    <div id="mobile-backdrop" class="mobile-backdrop md:hidden" onclick="toggleMobileMenu()"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="w-64 flex-shrink-0 flex flex-col border-r border-[#E9E9E7] bg-[#F7F7F5] hidden md:flex fixed md:relative inset-y-0 left-0 z-50 md:z-auto transition-transform duration-300">
        <div class="h-16 flex items-center justify-between px-6 border-b border-[#E9E9E7]">
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 bg-black rounded-md flex items-center justify-center text-white">
                    <i class="ph ph-shield-check text-sm"></i>
                </div>
                <span class="font-semibold text-[15px] tracking-tight">PrivacyGuard AI</span>
            </div>
            <button onclick="toggleMobileMenu()" class="md:hidden p-1 text-gray-500 hover:text-gray-900">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>

        <nav class="flex-1 px-3 py-4 space-y-1 overflow-y-auto">
            <button onclick="router('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-squares-four text-lg"></i>
                <span>Dashboard</span>
            </button>

            <button onclick="router('analytics')" id="nav-analytics" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-chart-line text-lg"></i>
                <span>Analytics</span>
            </button>

            <div class="pt-4 pb-2 px-3">
                <p class="text-[10px] font-medium text-gray-400 uppercase tracking-widest">Scanners</p>
            </div>

            <button onclick="router('prompt')" id="nav-prompt" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-robot text-lg"></i>
                <span>AI Prompt Check</span>
            </button>

            <button onclick="router('email')" id="nav-email" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-envelope-simple-open text-lg"></i>
                <span>Email & Scam</span>
            </button>

            <button onclick="router('website')" id="nav-website" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-globe text-lg"></i>
                <span>Website Audit</span>
            </button>
            
            <button onclick="router('exposure')" id="nav-exposure" class="nav-item w-full flex items-center gap-3 px-3 py-2 rounded-md text-sm text-gray-500 hover:bg-[#E3E2E0] hover:text-gray-900 transition-colors">
                <i class="ph ph-user-focus text-lg"></i>
                <span>Content Exposure</span>
            </button>
        </nav>

        <div class="p-4 border-t border-[#E9E9E7]">
            <div class="glass rounded-xl p-4 mb-4 border border-green-100">
                <div class="flex items-start gap-3">
                    <div class="p-2 bg-gradient-to-br from-green-400 to-emerald-500 rounded-lg shadow-lg shadow-green-500/20">
                        <i class="ph ph-lock-key text-white text-sm"></i>
                    </div>
                    <div>
                        <h4 class="text-xs font-bold text-gray-900 flex items-center gap-1">100% Local <span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span></h4>
                        <p class="text-[10px] text-gray-500 leading-relaxed mt-1">All scanning happens on your device. No data ever leaves your browser.</p>
                    </div>
                </div>
            </div>
            <a href="index.html" class="w-full flex items-center justify-center gap-2 px-3 py-2.5 text-xs font-medium text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-xl transition-all mb-3">
                <i class="ph ph-arrow-left text-sm"></i>
                <span>Back to Home</span>
            </a>
            <div class="flex items-center justify-between px-3 py-2 text-xs text-gray-400 bg-gray-50 rounded-lg">
                <span class="font-mono">v2.0.0</span>
                <button onclick="toggleShortcuts()" class="hover:text-gray-600 flex items-center gap-1 transition-colors" title="Keyboard Shortcuts">
                    <i class="ph ph-keyboard text-sm"></i>
                    <span class="text-[10px]">?</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full overflow-hidden bg-white md:bg-[#F7F7F5]">
        <header class="md:hidden h-14 bg-white border-b border-[#E9E9E7] flex items-center justify-between px-4">
            <a href="index.html" class="flex items-center gap-2">
                <div class="w-6 h-6 bg-black rounded-md flex items-center justify-center text-white">
                    <i class="ph ph-shield-check text-sm"></i>
                </div>
                <span class="font-semibold text-sm">PrivacyGuard</span>
            </a>
            <button onclick="toggleMobileMenu()" class="p-2 text-gray-600">
                <i class="ph ph-list text-xl"></i>
            </button>
        </header>

        <div id="app-container" class="flex-1 overflow-y-auto p-4 md:p-8"></div>
    </main>

    <!-- Real-time Indicator -->
    <div id="realtime-indicator" class="realtime-indicator">
        <div id="risk-dot" class="w-3 h-3 rounded-full bg-gray-300"></div>
        <div>
            <div class="flex items-center gap-2">
                <span class="text-xs text-gray-500">Risk:</span>
                <span id="risk-score-live" class="text-sm font-bold text-gray-400">0</span>
            </div>
        </div>
        <div class="text-xs text-gray-400" id="word-count">0 words</div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2"></div>

    <!-- Settings Backdrop & Panel -->
    <div id="settings-backdrop" class="settings-backdrop" onclick="toggleSettings()"></div>
    <div id="settings-panel" class="settings-panel">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between sticky top-0 bg-white z-10">
            <div>
                <h3 class="font-semibold text-lg">Settings</h3>
                <p class="text-xs text-gray-500 mt-1">Customize your scanner</p>
            </div>
            <button onclick="toggleSettings()" class="p-2 hover:bg-gray-100 rounded-lg">
                <i class="ph ph-x text-xl text-gray-600"></i>
            </button>
        </div>

        <div class="p-6 space-y-6">
            <!-- UI Settings -->
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="ph ph-palette"></i> Appearance
                </h4>
                <div class="space-y-3">
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-moon text-lg text-gray-600"></i>
                            <span class="text-sm font-medium">Dark Mode</span>
                        </div>
                        <input type="checkbox" id="toggle-dark-mode" class="toggle-switch" onchange="toggleDarkMode()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-activity text-lg text-gray-600"></i>
                            <span class="text-sm font-medium">Real-time Risk Indicator</span>
                        </div>
                        <input type="checkbox" id="toggle-realtime" class="toggle-switch" checked onchange="toggleRealtime()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-columns text-lg text-gray-600"></i>
                            <span class="text-sm font-medium">Comparison Mode</span>
                        </div>
                        <input type="checkbox" id="toggle-comparison" class="toggle-switch" onchange="toggleComparisonMode()">
                    </label>
                </div>
            </div>

            <!-- Scan Presets -->
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="ph ph-sliders"></i> Scan Preset
                </h4>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="setScanPreset('quick')" id="preset-quick" class="p-3 border-2 border-gray-200 rounded-lg text-center hover:border-gray-400 transition-colors">
                        <i class="ph ph-lightning text-xl text-yellow-500"></i>
                        <p class="text-xs font-medium mt-1">Quick</p>
                    </button>
                    <button onclick="setScanPreset('deep')" id="preset-deep" class="p-3 border-2 border-gray-200 rounded-lg text-center hover:border-gray-400 transition-colors">
                        <i class="ph ph-magnifying-glass text-xl text-blue-500"></i>
                        <p class="text-xs font-medium mt-1">Deep</p>
                    </button>
                    <button onclick="setScanPreset('paranoid')" id="preset-paranoid" class="p-3 border-2 border-gray-200 rounded-lg text-center hover:border-gray-400 transition-colors">
                        <i class="ph ph-shield-warning text-xl text-red-500"></i>
                        <p class="text-xs font-medium mt-1">Paranoid</p>
                    </button>
                </div>
            </div>

            <!-- Detection Categories -->
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="ph ph-faders"></i> Detection Categories
                </h4>
                <div class="space-y-2">
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-user text-lg text-red-500"></i>
                            <div>
                                <span class="text-sm font-medium">Personal Information</span>
                                <p class="text-xs text-gray-500">SSN, emails, phones, addresses</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-pii" class="toggle-switch" checked onchange="updateCategories()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-key text-lg text-purple-500"></i>
                            <div>
                                <span class="text-sm font-medium">Credentials & Secrets</span>
                                <p class="text-xs text-gray-500">API keys, passwords, tokens</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-credentials" class="toggle-switch" checked onchange="updateCategories()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-warning text-lg text-yellow-500"></i>
                            <div>
                                <span class="text-sm font-medium">Scam Indicators</span>
                                <p class="text-xs text-gray-500">Phishing, urgency, fraud</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-scam" class="toggle-switch" checked onchange="updateCategories()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-briefcase text-lg text-blue-500"></i>
                            <div>
                                <span class="text-sm font-medium">Corporate & Confidential</span>
                                <p class="text-xs text-gray-500">NDA, revenue, secrets</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-corporate" class="toggle-switch" checked onchange="updateCategories()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-scales text-lg text-orange-500"></i>
                            <div>
                                <span class="text-sm font-medium">Compliance</span>
                                <p class="text-xs text-gray-500">GDPR, HIPAA, COPPA</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-compliance" class="toggle-switch" checked onchange="updateCategories()">
                    </label>
                </div>
            </div>

            <!-- Custom Patterns -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                        <i class="ph ph-code"></i> Custom Patterns
                    </h4>
                    <button onclick="showPatternWizard()" class="text-xs text-blue-600 hover:underline">+ Add</button>
                </div>
                <div id="custom-patterns-list" class="space-y-2">
                    <p class="text-xs text-gray-500 italic">No custom patterns yet</p>
                </div>
            </div>

            <!-- Whitelist -->
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
                        <i class="ph ph-check-circle"></i> Whitelist
                    </h4>
                </div>
                <div id="whitelist-items" class="space-y-2">
                    <p class="text-xs text-gray-500 italic">No whitelisted items</p>
                </div>
            </div>

            <!-- Security -->
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="ph ph-shield-check"></i> Security & Privacy
                </h4>
                <div class="space-y-2">
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-lock-key text-lg text-green-600"></i>
                            <div>
                                <span class="text-sm font-medium">Encrypt History</span>
                                <p class="text-xs text-gray-500">AES-256 encryption</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-encryption" class="toggle-switch" onchange="toggleEncryption()">
                    </label>
                    <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-timer text-lg text-blue-600"></i>
                            <div>
                                <span class="text-sm font-medium">Session Only</span>
                                <p class="text-xs text-gray-500">Clear on close</p>
                            </div>
                        </div>
                        <input type="checkbox" id="toggle-session" class="toggle-switch" onchange="toggleSessionOnly()">
                    </label>
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="ph ph-trash text-lg text-red-500"></i>
                            <div>
                                <span class="text-sm font-medium">Auto-Delete</span>
                                <p class="text-xs text-gray-500">Clear after days</p>
                            </div>
                        </div>
                        <select id="auto-delete-days" class="text-sm border rounded-lg px-2 py-1" onchange="setAutoDelete()">
                            <option value="0">Never</option>
                            <option value="1">1 day</option>
                            <option value="7">7 days</option>
                            <option value="30">30 days</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Data Management -->
            <div>
                <h4 class="text-sm font-semibold text-gray-900 mb-3 flex items-center gap-2">
                    <i class="ph ph-database"></i> Data Management
                </h4>
                <div class="space-y-2">
                    <button onclick="exportAllData()" class="w-full flex items-center gap-2 p-3 bg-gray-50 rounded-lg hover:bg-gray-100 text-left">
                        <i class="ph ph-download text-lg text-blue-600"></i>
                        <span class="text-sm font-medium">Export All Data</span>
                    </button>
                    <button onclick="confirmClearAll()" class="w-full flex items-center gap-2 p-3 bg-red-50 rounded-lg hover:bg-red-100 text-left">
                        <i class="ph ph-trash text-lg text-red-600"></i>
                        <span class="text-sm font-medium text-red-600">Clear All Data</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Panel -->
    <div id="shortcuts-panel" class="shortcuts-panel">
        <div class="flex items-center justify-between mb-4">
            <h3 class="font-semibold text-lg">Keyboard Shortcuts</h3>
            <button onclick="toggleShortcuts()" class="p-1 hover:bg-gray-100 rounded">
                <i class="ph ph-x text-lg"></i>
            </button>
        </div>
        <div class="space-y-3 text-sm">
            <div class="flex justify-between"><span>Run Scan</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl + Enter</kbd></div>
            <div class="flex justify-between"><span>Copy Redacted</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl + Shift + C</kbd></div>
            <div class="flex justify-between"><span>Toggle Dark Mode</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl + D</kbd></div>
            <div class="flex justify-between"><span>Open Settings</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl + ,</kbd></div>
            <div class="flex justify-between"><span>Show Shortcuts</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">?</kbd></div>
            <div class="flex justify-between"><span>Undo</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl + Z</kbd></div>
            <div class="flex justify-between"><span>Close Modal</span><kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Esc</kbd></div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" class="onboarding-overlay">
        <div class="onboarding-card">
            <div id="onboarding-content">
                <!-- Dynamic content -->
            </div>
            <div class="flex justify-center gap-2 mt-6" id="onboarding-dots">
                <div class="w-2 h-2 rounded-full bg-black"></div>
                <div class="w-2 h-2 rounded-full bg-gray-300"></div>
                <div class="w-2 h-2 rounded-full bg-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Pattern Wizard Overlay -->
    <div id="pattern-wizard-overlay" class="pattern-wizard-overlay">
        <div class="pattern-wizard">
            <div class="p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-semibold text-lg">Add Custom Pattern</h3>
                <button onclick="closePatternWizard()" class="p-1 hover:bg-gray-100 rounded">
                    <i class="ph ph-x text-lg"></i>
                </button>
            </div>
            <div class="p-6" id="pattern-wizard-content">
                <!-- Dynamic content -->
            </div>
        </div>
    </div>

    <!-- Confetti Container -->
    <div id="confetti-container"></div>

<script>
// =============================================
// 55+ DETECTION PATTERNS
// =============================================
const patterns = {
    pii: [
        { id: 'email', name: 'Email Address', regex: /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g, risk: 25, confidence: 'medium', category: 'pii', desc: 'Email address detected' },
        { id: 'phone', name: 'Phone Number', regex: /(\+\d{1,3}[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}/g, risk: 30, confidence: 'medium', category: 'pii', desc: 'Phone number detected' },
        { id: 'ssn', name: 'SSN (US)', regex: /\b\d{3}-\d{2}-\d{4}\b/g, risk: 95, confidence: 'high', category: 'pii', desc: 'Social Security Number - CRITICAL' },
        { id: 'credit_card', name: 'Credit Card', regex: /\b(?:\d{4}[-\s]?){3}\d{4}\b/g, risk: 95, confidence: 'high', category: 'pii', desc: 'Credit card number - CRITICAL' },
        { id: 'cvv', name: 'CVV Code', regex: /\b(cvv|cvc|csc)[\s:]*\d{3,4}\b/gi, risk: 90, confidence: 'high', category: 'pii', desc: 'Card security code detected' },
        { id: 'passport', name: 'Passport Number', regex: /\b[A-Z]{1,2}\d{6,9}\b/g, risk: 85, confidence: 'medium', category: 'pii', desc: 'Potential passport number' },
        { id: 'drivers_license', name: 'Drivers License', regex: /\b[A-Z]\d{7,8}\b/g, risk: 70, confidence: 'low', category: 'pii', desc: 'Potential drivers license' },
        { id: 'dob', name: 'Date of Birth', regex: /\b(0?[1-9]|1[0-2])[\/\-](0?[1-9]|[12]\d|3[01])[\/\-](19|20)\d{2}\b/g, risk: 40, confidence: 'medium', category: 'pii', desc: 'Date of birth detected' },
        { id: 'address', name: 'Street Address', regex: /\b\d{1,5}\s+([A-Z][a-z]+\s+){1,3}(Street|St|Avenue|Ave|Road|Rd|Drive|Dr|Lane|Ln|Boulevard|Blvd|Way|Court|Ct)\b/gi, risk: 50, confidence: 'medium', category: 'pii', desc: 'Street address detected' },
        { id: 'zipcode', name: 'ZIP Code', regex: /\b\d{5}(-\d{4})?\b/g, risk: 15, confidence: 'low', category: 'pii', desc: 'ZIP code detected' },
        { id: 'ip_private', name: 'Private IP', regex: /\b(192\.168\.\d{1,3}\.\d{1,3}|10\.\d{1,3}\.\d{1,3}\.\d{1,3}|172\.(1[6-9]|2\d|3[01])\.\d{1,3}\.\d{1,3})\b/g, risk: 60, confidence: 'high', category: 'pii', desc: 'Internal network IP exposed' },
        { id: 'ip_public', name: 'Public IP', regex: /\b(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\b/g, risk: 20, confidence: 'low', category: 'pii', desc: 'IP address detected' },
        { id: 'mac', name: 'MAC Address', regex: /\b([0-9A-Fa-f]{2}[:-]){5}([0-9A-Fa-f]{2})\b/g, risk: 40, confidence: 'high', category: 'pii', desc: 'MAC address detected' },
        { id: 'gps', name: 'GPS Coordinates', regex: /\b-?\d{1,3}\.\d{4,},\s*-?\d{1,3}\.\d{4,}\b/g, risk: 60, confidence: 'medium', category: 'pii', desc: 'GPS coordinates detected' },
        { id: 'iban', name: 'IBAN', regex: /\b[A-Z]{2}\d{2}[A-Z0-9]{4,30}\b/g, risk: 80, confidence: 'medium', category: 'pii', desc: 'International bank account' },
        { id: 'bitcoin', name: 'Bitcoin Address', regex: /\b(bc1|[13])[a-zA-HJ-NP-Z0-9]{25,39}\b/g, risk: 50, confidence: 'high', category: 'pii', desc: 'Cryptocurrency address' },
        { id: 'ethereum', name: 'Ethereum Address', regex: /\b0x[a-fA-F0-9]{40}\b/g, risk: 50, confidence: 'high', category: 'pii', desc: 'Ethereum address' },
        { id: 'medical_record', name: 'Medical Record Number', regex: /\b(MRN|Medical Record)[\s:#]*\d{6,10}\b/gi, risk: 85, confidence: 'medium', category: 'pii', desc: 'Medical record number' }
    ],
    credentials: [
        { id: 'openai_key', name: 'OpenAI API Key', regex: /sk-[a-zA-Z0-9]{32,}/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'OpenAI key - CRITICAL' },
        { id: 'google_api', name: 'Google API Key', regex: /AIza[0-9A-Za-z\-_]{35}/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'Google API key exposed' },
        { id: 'aws_access', name: 'AWS Access Key', regex: /AKIA[0-9A-Z]{16}/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'AWS key - CRITICAL' },
        { id: 'aws_secret', name: 'AWS Secret Key', regex: /[0-9a-zA-Z\/+]{40}/g, risk: 90, confidence: 'low', category: 'credentials', desc: 'Potential AWS secret' },
        { id: 'github_token', name: 'GitHub Token', regex: /ghp_[a-zA-Z0-9]{36}/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'GitHub token exposed' },
        { id: 'jwt', name: 'JWT Token', regex: /eyJ[a-zA-Z0-9_-]*\.eyJ[a-zA-Z0-9_-]*\.[a-zA-Z0-9_-]*/g, risk: 85, confidence: 'high', category: 'credentials', desc: 'JWT token detected' },
        { id: 'stripe_key', name: 'Stripe Key', regex: /(sk|pk)_(test|live)_[a-zA-Z0-9]{24,}/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'Stripe key exposed' },
        { id: 'slack_token', name: 'Slack Token', regex: /xox[baprs]-[0-9a-zA-Z]{10,}/g, risk: 90, confidence: 'high', category: 'credentials', desc: 'Slack token detected' },
        { id: 'password_field', name: 'Password Field', regex: /\b(password|passwd|pwd)[\s]*[=:]\s*["']?[^\s"']{4,}/gi, risk: 85, confidence: 'high', category: 'credentials', desc: 'Password detected' },
        { id: 'db_connection', name: 'Database Connection', regex: /(mysql|postgres|mongodb|redis):\/\/[^\s]+/gi, risk: 95, confidence: 'high', category: 'credentials', desc: 'Database connection string' },
        { id: 'ssh_key', name: 'SSH Private Key', regex: /-----BEGIN (RSA |OPENSSH |DSA |EC )?PRIVATE KEY-----/g, risk: 100, confidence: 'high', category: 'credentials', desc: 'SSH private key - CRITICAL' },
        { id: 'env_variable', name: 'Environment Variable', regex: /(API_KEY|SECRET_KEY|AUTH_TOKEN|PRIVATE_KEY)\s*=\s*["']?[a-zA-Z0-9_-]{8,}/gi, risk: 80, confidence: 'medium', category: 'credentials', desc: 'Environment secret' }
    ],
    scam: [
        { id: 'urgency', name: 'Urgency Language', words: ['immediately', 'urgent', 'act now', 'limited time', 'expires', 'hurry', 'dont wait', "don't wait", 'right away', 'asap', 'final notice', 'last chance'], risk: 35, confidence: 'medium', category: 'scam', desc: 'Creates pressure to act' },
        { id: 'financial_bait', name: 'Financial Bait', words: ['claim prize', 'you won', 'lottery', 'inheritance', 'free money', 'cash reward', 'million dollars', 'wire transfer', 'bank transfer', 'gift card'], risk: 60, confidence: 'high', category: 'scam', desc: 'Financial lure detected' },
        { id: 'authority', name: 'Authority Impersonation', words: ['irs', 'fbi', 'police', 'government', 'microsoft support', 'apple support', 'tech support', 'legal action', 'lawsuit', 'arrest warrant'], risk: 50, confidence: 'medium', category: 'scam', desc: 'Impersonates authority' },
        { id: 'phishing', name: 'Phishing Tactics', words: ['verify your account', 'confirm your identity', 'update payment', 'suspended account', 'unusual activity', 'click here', 'click this link', 'click below'], risk: 55, confidence: 'high', category: 'scam', desc: 'Phishing attempt' },
        { id: 'romance', name: 'Romance Scam', words: ['my dear', 'my love', 'send money', 'western union', 'help me', 'stuck abroad', 'need funds', 'true love'], risk: 65, confidence: 'medium', category: 'scam', desc: 'Romance scam indicators' },
        { id: 'crypto_scam', name: 'Crypto Scam', words: ['guaranteed returns', 'double bitcoin', 'crypto investment', 'trading bot', 'passive income', '100x gains', 'pump'], risk: 70, confidence: 'high', category: 'scam', desc: 'Crypto scam detected' },
        { id: 'threats', name: 'Threat Language', words: ['account locked', 'access terminated', 'legal consequences', 'prosecuted', 'reported to police', 'share video', 'expose you'], risk: 60, confidence: 'high', category: 'scam', desc: 'Threatening language' }
    ],
    scam_urls: [
        { id: 'suspicious_tld', name: 'Suspicious Domain', regex: /\.(xyz|top|click|loan|work|gq|cf|tk|ml|ga|pw|cc|su|ru|cn)(\b|\/)/gi, risk: 45, confidence: 'medium', category: 'scam', desc: 'Suspicious domain extension' },
        { id: 'url_shortener', name: 'URL Shortener', regex: /(bit\.ly|tinyurl|t\.co|goo\.gl|ow\.ly|is\.gd|buff\.ly|short\.link)/gi, risk: 25, confidence: 'medium', category: 'scam', desc: 'Shortened URL - verify destination' },
        { id: 'ip_url', name: 'IP-based URL', regex: /https?:\/\/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/g, risk: 55, confidence: 'high', category: 'scam', desc: 'URL uses IP instead of domain' },
        { id: 'http_url', name: 'Insecure HTTP', regex: /http:\/\/(?!localhost)[^\s]+/g, risk: 30, confidence: 'high', category: 'scam', desc: 'Insecure HTTP link' }
    ],
    scam_money: [
        { id: 'money_amount', name: 'Money Amount', regex: /(\$|USD|EUR||)\s*\d{1,3}(,?\d{3})*(\.\d{2})?|\d{1,3}(,?\d{3})*\s*(dollars|USD|EUR|euros|pounds)/gi, risk: 30, confidence: 'medium', category: 'scam', desc: 'Money amount mentioned' },
        { id: 'free_offer', name: 'Free Offer', regex: /\bfree\s+(money|cash|gift|iphone|laptop|prize|vacation)/gi, risk: 50, confidence: 'high', category: 'scam', desc: '"Free" offer - likely scam' }
    ],
    corporate: [
        { id: 'confidential', name: 'Confidential Marker', words: ['confidential', 'internal only', 'do not share', 'proprietary', 'trade secret', 'nda', 'non-disclosure', 'embargoed'], risk: 70, confidence: 'high', category: 'corporate', desc: 'Confidential information' },
        { id: 'financial', name: 'Financial Data', words: ['revenue', 'profit margin', 'quarterly earnings', 'budget', 'forecast', 'valuation', 'burn rate', 'runway'], risk: 55, confidence: 'medium', category: 'corporate', desc: 'Financial data exposed' },
        { id: 'merger', name: 'M&A Information', words: ['merger', 'acquisition', 'buyout', 'takeover', 'due diligence', 'letter of intent', 'term sheet'], risk: 80, confidence: 'high', category: 'corporate', desc: 'M&A information' },
        { id: 'unreleased', name: 'Unreleased Product', words: ['codename', 'unreleased', 'upcoming launch', 'internal roadmap', 'beta only', 'not public'], risk: 65, confidence: 'medium', category: 'corporate', desc: 'Unreleased product info' },
        { id: 'employee', name: 'Employee Data', words: ['employee list', 'salary data', 'performance review', 'termination', 'hr record', 'personnel file'], risk: 75, confidence: 'high', category: 'corporate', desc: 'Employee data exposed' },
        { id: 'legal', name: 'Legal Information', words: ['attorney-client', 'legal opinion', 'settlement', 'litigation', 'subpoena', 'cease and desist'], risk: 70, confidence: 'high', category: 'corporate', desc: 'Legal information' }
    ],
    compliance: [
        { id: 'hipaa', name: 'HIPAA Data', words: ['patient', 'diagnosis', 'treatment', 'prescription', 'medical record', 'health information', 'phi', 'protected health'], risk: 85, confidence: 'high', category: 'compliance', desc: 'HIPAA protected data' },
        { id: 'gdpr', name: 'GDPR Personal Data', words: ['data subject', 'right to erasure', 'processing consent', 'data controller', 'personal data breach'], risk: 70, confidence: 'medium', category: 'compliance', desc: 'GDPR related content' },
        { id: 'pci', name: 'PCI DSS Data', words: ['cardholder data', 'primary account number', 'payment card', 'cvv', 'magnetic stripe'], risk: 90, confidence: 'high', category: 'compliance', desc: 'PCI DSS data' },
        { id: 'coppa', name: 'COPPA Data', words: ['child under 13', 'parental consent', 'minor data', 'childrens privacy'], risk: 80, confidence: 'high', category: 'compliance', desc: 'Children data - COPPA' }
    ]
};

const demoExamples = {
    prompt: `Help me debug this code. My OpenAI key is sk-abc123def456ghi789jkl012mno345pqr678. 
The database connection is mongodb://admin:password123@192.168.1.50:27017/production.
My email is john.developer@company.com and phone is 555-123-4567.
The AWS key is AKIAIOSFODNN7EXAMPLE.`,
    email: `URGENT: Your account has been suspended!

Dear Customer,

We detected unusual activity on your account. Your access will be TERMINATED within 24 hours unless you verify your identity immediately.

Click here to verify: http://secure-bank-login.xyz/verify

You must confirm your:
- Social Security Number
- Credit Card Details  
- Bank Account Number

This is your FINAL NOTICE. Act now to avoid legal action.

Best regards,
Security Team
IRS Fraud Department`,
    website: `https://free-prize-winner.xyz/claim?user=12345&ssn=123-45-6789&cc=4532015112830366&redirect=http://192.168.1.1/steal&utm_source=scam&gclid=abc123`,
    exposure: `About Me:
I'm John Smith, born on 03/15/1985. I live at 123 Main Street, New York, NY 10001.
You can reach me at john.smith@gmail.com or call 555-867-5309.

Currently working as Senior Engineer at Google (Employee ID: EMP-847291).
My SSN is 123-45-6789 and my driver's license is D1234567.

Connect with me:
- GPS: 40.7128, -74.0060 (my apartment)
- Bitcoin: 1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2`
};

// =============================================
// STATE MANAGEMENT
// =============================================
const state = {
    currentView: 'dashboard',
    scanHistory: [],
    undoStack: [],
    redoStack: [],
    stats: { scans: 0, risksFound: 0 },
    lastScanResult: null,
    onboardingComplete: false,
    settings: {
        categories: { pii: true, credentials: true, scam: true, corporate: true, compliance: true },
        ui: { darkMode: true, realtime: true, comparison: false },
        security: { encryption: false, sessionOnly: false, autoDeleteDays: 0 },
        scanPreset: 'deep',
        customPatterns: [],
        whitelist: []
    }
};

// Load state from storage
function loadState() {
    try {
        const saved = state.settings.security.sessionOnly 
            ? sessionStorage.getItem('privacyguard')
            : localStorage.getItem('privacyguard');
        if (saved) {
            const parsed = JSON.parse(saved);
            Object.assign(state, parsed);
        }
    } catch (e) { console.log('Could not load state'); }
}

function saveState() {
    try {
        const storage = state.settings.security.sessionOnly ? sessionStorage : localStorage;
        storage.setItem('privacyguard', JSON.stringify(state));
    } catch (e) { console.log('Could not save state'); }
}

loadState();

// =============================================
// INTELLIGENT ANALYSIS ENGINE (v2) - Helper Functions
// =============================================

// Checksum Validation: Luhn algorithm for credit cards
function luhnCheck(num) {
    if (!num || typeof num !== 'string') return false;
    const digits = num.replace(/\D/g, '');
    if (digits.length < 13 || digits.length > 19) return false;
    let sum = 0, isEven = false;
    for (let i = digits.length - 1; i >= 0; i--) {
        let digit = parseInt(digits[i], 10);
        if (isEven) digit *= 2;
        if (digit > 9) digit -= 9;
        sum += digit;
        isEven = !isEven;
    }
    return sum % 10 === 0;
}

// SSN Validation: Check format and invalid patterns
function validateSSN(ssn) {
    const num = ssn.replace(/\D/g, '');
    if (num.length !== 9) return false;
    // Check for all zeros or all same digit
    if (/^(\d)\1{8}$/.test(num)) return false;
    // Area number can't be 0, 666, or 900-999
    const area = parseInt(num.substring(0, 3));
    if (area === 0 || area === 666 || area >= 900) return false;
    return true;
}

// IBAN Validation: International Bank Account Number format check
function validateIBAN(iban) {
    const code = iban.replace(/\s/g, '').toUpperCase();
    if (!/^[A-Z]{2}\d{2}[A-Z0-9]{4,30}$/.test(code)) return false;
    return true;
}

// Deduplication Engine: Track unique findings and their counts
function deduplicateFindings(findings) {
    const uniqueMap = new Map();
    const dedupedFindings = [];
    
    findings.forEach(f => {
        // Create unique key: pattern ID + value (exact match)
        const key = `${f.id}-${f.value}`;
        if (uniqueMap.has(key)) {
            const existing = uniqueMap.get(key);
            existing.count = (existing.count || 1) + 1;
        } else {
            const deduped = { ...f, count: 1 };
            uniqueMap.set(key, deduped);
            dedupedFindings.push(deduped);
        }
    });
    
    return dedupedFindings;
}

// Pattern Combination Detection: Higher risk when multiple PII types found
function detectRiskCombinations(dedupedFindings) {
    const risks = { ssn: false, phone: false, email: false, address: false, dob: false };
    let combinationBonus = 1.0;
    
    dedupedFindings.forEach(f => {
        if (f.id === 'ssn') risks.ssn = true;
        if (f.id === 'phone') risks.phone = true;
        if (f.id === 'email') risks.email = true;
        if (f.id === 'address') risks.address = true;
        if (f.id === 'dob') risks.dob = true;
    });
    
    // Identity theft risk: SSN + Address + DOB = CRITICAL (2.0x multiplier)
    if (risks.ssn && risks.address && risks.dob) combinationBonus = 2.0;
    // Account takeover: Email + Phone + SSN = SEVERE (1.8x)
    else if (risks.email && risks.phone && risks.ssn) combinationBonus = 1.8;
    // Account compromise: Email + Phone = HIGH (1.3x)
    else if (risks.email && risks.phone) combinationBonus = 1.3;
    // Location + identity: Address + Phone = MEDIUM (1.2x)
    else if (risks.address && risks.phone) combinationBonus = 1.2;
    
    return combinationBonus;
}

// Confidence-weighted scoring: Higher confidence = higher impact
function calculateWeightedRisk(finding) {
    let baseRisk = finding.risk;
    
    // Apply confidence multiplier
    const confidenceMultiplier = {
        'high': 1.0,
        'medium': 0.8,
        'low': 0.5
    }[finding.confidence] || 1.0;
    
    return baseRisk * confidenceMultiplier;
}

// =============================================
// ANALYSIS ENGINE
// =============================================
function analyzeText(text, mode = 'general') {
    if (!text.trim()) return { score: 0, findings: [], status: 'Empty', color: 'text-gray-400', highlightedText: '', redactedText: '', allFindings: [] };

    let rawFindings = [];
    let redactMap = [];
    const cats = state.settings.categories;

    // Preset adjustment: adjust confidence threshold and multiplier
    const presetSettings = { 
        quick: { multiplier: 0.7, confidenceFloor: 'medium' }, 
        deep: { multiplier: 1, confidenceFloor: 'low' }, 
        paranoid: { multiplier: 1.5, confidenceFloor: 'low' } 
    }[state.settings.scanPreset] || { multiplier: 1, confidenceFloor: 'low' };

    // Check whitelist
    const isWhitelisted = (value) => state.settings.whitelist.some(w => value.includes(w));

    // PII Patterns - with checksum validation for credentials
    if (cats.pii) {
        patterns.pii.forEach(p => {
            const matches = text.matchAll(new RegExp(p.regex.source, 'g'));
            for (const match of matches) {
                const m = match[0];
                if (isWhitelisted(m)) continue;
                
                // Smart validation before adding
                let isValid = true;
                let adjustedRisk = calculateWeightedRisk(p);
                
                // Checksum validation for critical findings
                if (p.id === 'credit_card') isValid = luhnCheck(m);
                if (p.id === 'ssn') isValid = validateSSN(m);
                if (p.id === 'iban') isValid = validateIBAN(m);
                
                if (!isValid) continue;
                
                rawFindings.push({ ...p, value: m, type: 'Personal Info', adjustedRisk });
                redactMap.push({ original: m, replacement: `[${p.name.toUpperCase()}]` });
            }
        });
    }

    // Credential Patterns - highest priority, all should be flagged
    if (cats.credentials) {
        patterns.credentials.forEach(p => {
            const matches = text.matchAll(new RegExp(p.regex.source, 'g'));
            for (const match of matches) {
                const m = match[0];
                if (isWhitelisted(m)) continue;
                
                const adjustedRisk = calculateWeightedRisk(p);
                rawFindings.push({ ...p, value: m, type: 'Credentials', adjustedRisk });
                redactMap.push({ original: m, replacement: `[${p.name.toUpperCase()}]` });
            }
        });
    }

    // Scam Word Patterns - deduplicate per pattern, count unique occurrences
    if (cats.scam) {
        patterns.scam.forEach(p => {
            const uniqueWords = new Set();
            p.words.forEach(word => {
                const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')}\\b`, 'gi');
                const matches = text.matchAll(regex);
                for (const match of matches) {
                    if (!isWhitelisted(word) && !uniqueWords.has(word)) {
                        uniqueWords.add(word);
                        rawFindings.push({ ...p, value: word, type: 'Scam Indicator', adjustedRisk: calculateWeightedRisk(p) });
                    }
                }
            });
        });

        // Scam URL Patterns
        patterns.scam_urls.forEach(p => {
            const matches = text.matchAll(new RegExp(p.regex.source, 'g'));
            for (const match of matches) {
                const m = match[0];
                if (isWhitelisted(m)) continue;
                rawFindings.push({ ...p, value: m, type: 'Suspicious URL', adjustedRisk: calculateWeightedRisk(p) });
            }
        });

        // Money Patterns
        patterns.scam_money.forEach(p => {
            const matches = text.matchAll(new RegExp(p.regex.source, 'g'));
            for (const match of matches) {
                const m = match[0];
                if (isWhitelisted(m)) continue;
                rawFindings.push({ ...p, value: m, type: 'Financial Lure', adjustedRisk: calculateWeightedRisk(p) });
            }
        });
    }

    // Corporate Patterns - with deduplication per pattern
    if (cats.corporate) {
        patterns.corporate.forEach(p => {
            const foundWords = new Set();
            p.words.forEach(word => {
                const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')}\\b`, 'gi');
                const matches = text.matchAll(regex);
                for (const match of matches) {
                    if (!isWhitelisted(word) && !foundWords.has(word)) {
                        foundWords.add(word);
                        rawFindings.push({ ...p, value: word, type: 'Corporate Data', adjustedRisk: calculateWeightedRisk(p) });
                    }
                }
            });
        });
    }

    // Compliance Patterns - with deduplication per pattern
    if (cats.compliance) {
        patterns.compliance.forEach(p => {
            const foundWords = new Set();
            p.words.forEach(word => {
                const regex = new RegExp(`\\b${word.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&')}\\b`, 'gi');
                const matches = text.matchAll(regex);
                for (const match of matches) {
                    if (!isWhitelisted(word) && !foundWords.has(word)) {
                        foundWords.add(word);
                        rawFindings.push({ ...p, value: word, type: 'Compliance Risk', adjustedRisk: calculateWeightedRisk(p) });
                    }
                }
            });
        });
    }

    // Custom Patterns
    state.settings.customPatterns.forEach(p => {
        try {
            const regex = new RegExp(p.regex, 'gi');
            const matches = text.matchAll(regex);
            for (const match of matches) {
                const m = match[0];
                if (isWhitelisted(m)) continue;
                rawFindings.push({ ...p, value: m, type: 'Custom Pattern', adjustedRisk: calculateWeightedRisk(p) });
                redactMap.push({ original: m, replacement: `[${p.name.toUpperCase()}]` });
            }
        } catch (e) { console.log('Invalid custom pattern:', p.name); }
    });

    // ========== INTELLIGENT POST-PROCESSING ==========
    // 1. Deduplication: Remove duplicate findings, track counts
    const dedupedFindings = deduplicateFindings(rawFindings);
    
    // 2. Pattern Combination Detection: Detect high-risk combinations
    const combinationBonus = detectRiskCombinations(dedupedFindings);
    
    // 3. Calculate intelligent score with confidence weighting
    let score = 0;
    const findings = dedupedFindings.map(f => {
        // Base risk adjusted for confidence
        let finalRisk = f.adjustedRisk || f.risk;
        
        // Apply combination multiplier (e.g., SSN + Address + DOB = 2.0x)
        finalRisk *= combinationBonus;
        
        // Apply preset multiplier (quick: 0.7x, deep: 1x, paranoid: 1.5x)
        finalRisk *= presetSettings.multiplier;
        
        score += finalRisk;
        return { ...f, finalRisk: Math.round(finalRisk) };
    });

    // Create highlighted text
    let highlightedText = escapeHtml(text);
    findings.forEach(f => {
        if (f.value) {
            const escaped = escapeHtml(f.value).replace(/[.*+?^${}()|[\\]\\]/g, '\\$&');
            const regex = new RegExp(escaped, 'g');
            const riskThreshold = f.finalRisk > 60 ? 'highlight-risk' : 'highlight-warning';
            const countBadge = f.count > 1 ? ` [${f.count}x]` : '';
            highlightedText = highlightedText.replace(regex, `<span class="${riskThreshold}" title="${f.desc}${countBadge}">${escapeHtml(f.value)}</span>`);
        }
    });

    // Create redacted text
    let redactedText = text;
    redactMap.forEach(r => {
        const regex = new RegExp(r.original.replace(/[.*+?^${}()|[\\]\\]/g, '\\$&'), 'g');
        redactedText = redactedText.replace(regex, r.replacement);
    });

    // Cap score at 100 (logarithmic scale for very high scores)
    score = Math.min(Math.round(score), 100);

    // Status with intelligence
    let status = 'Safe', color = 'text-green-600';
    if (score > 30) { status = 'Caution'; color = 'text-yellow-600'; }
    if (score > 70) { status = 'High Risk'; color = 'text-red-600'; }
    // Check for critical credentials regardless of score
    const hasCriticalFindings = findings.some(f => f.risk >= 90 && ['credentials', 'pii'].includes(f.category));
    if (hasCriticalFindings) { status = 'CRITICAL'; color = 'text-red-600'; score = Math.max(score, 85); }

    // Group findings
    const groupedFindings = findings.reduce((acc, f) => {
        const cat = f.category || 'other';
        if (!acc[cat]) acc[cat] = [];
        acc[cat].push(f);
        return acc;
    }, {});

    return { score, findings, groupedFindings, allFindings: findings, status, color, highlightedText, redactedText };
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================
// UI COMPONENTS
// =============================================
const Components = {
    Dashboard: () => `
        <div class="max-w-4xl mx-auto space-y-8 fade-in">
            <div>
                <h1 class="text-3xl font-bold mb-2 bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">Privacy Dashboard</h1>
                <p class="text-gray-500">Your local security command center</p>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="stat-card bg-white p-6 rounded-2xl border border-[#E9E9E7] shadow-sm hover-lift">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-3 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg shadow-blue-500/20">
                            <i class="ph ph-scan text-xl text-white"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Total Scans</span>
                    </div>
                    <p class="text-4xl font-bold">${state.stats.scans}</p>
                    <p class="text-xs text-gray-400 mt-1">All time scans performed</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-2xl border border-[#E9E9E7] shadow-sm hover-lift">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-3 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl shadow-lg shadow-red-500/20">
                            <i class="ph ph-warning text-xl text-white"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Risks Found</span>
                    </div>
                    <p class="text-4xl font-bold text-red-600">${state.stats.risksFound}</p>
                    <p class="text-xs text-gray-400 mt-1">Privacy risks prevented</p>
                </div>
                <div class="stat-card bg-white p-6 rounded-2xl border border-[#E9E9E7] shadow-sm hover-lift">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="p-3 bg-gradient-to-br from-emerald-500 to-green-600 rounded-xl shadow-lg shadow-green-500/20">
                            <i class="ph ph-shield-check text-xl text-white"></i>
                        </div>
                        <span class="text-sm font-medium text-gray-500 uppercase tracking-wide">Status</span>
                    </div>
                    <p class="text-4xl font-bold text-emerald-600">Active</p>
                    <p class="text-xs text-gray-400 mt-1 flex items-center gap-1"><span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Protection enabled</p>
                </div>
            </div>

            <div class="bg-white rounded-2xl border border-[#E9E9E7] shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-[#E9E9E7] bg-gradient-to-r from-gray-50 to-white">
                    <h3 class="font-semibold flex items-center gap-2"><i class="ph ph-lightning text-yellow-500"></i> Quick Actions</h3>
                </div>
                <div class="p-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                    <button onclick="router('prompt')" class="quick-action p-5 rounded-xl text-center group bg-white">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-violet-100 to-purple-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph ph-robot text-2xl text-violet-600"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">AI Prompt</p>
                        <p class="text-xs text-gray-400 mt-1">Check prompts</p>
                    </button>
                    <button onclick="router('email')" class="quick-action p-5 rounded-xl text-center group bg-white">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-orange-100 to-amber-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph ph-envelope text-2xl text-orange-600"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">Email Scan</p>
                        <p class="text-xs text-gray-400 mt-1">Detect phishing</p>
                    </button>
                    <button onclick="router('website')" class="quick-action p-5 rounded-xl text-center group bg-white">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-cyan-100 to-blue-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph ph-globe text-2xl text-cyan-600"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">URL Check</p>
                        <p class="text-xs text-gray-400 mt-1">Analyze links</p>
                    </button>
                    <button onclick="router('exposure')" class="quick-action p-5 rounded-xl text-center group bg-white">
                        <div class="w-12 h-12 mx-auto mb-3 bg-gradient-to-br from-pink-100 to-rose-100 rounded-xl flex items-center justify-center group-hover:scale-110 transition-transform">
                            <i class="ph ph-user-focus text-2xl text-pink-600"></i>
                        </div>
                        <p class="text-sm font-semibold text-gray-700">Exposure</p>
                        <p class="text-xs text-gray-400 mt-1">Identity check</p>
                    </button>
                </div>
            </div>

            ${state.scanHistory.length > 0 ? `
            <div class="bg-white rounded-2xl border border-[#E9E9E7] shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-[#E9E9E7] flex justify-between items-center bg-gradient-to-r from-gray-50 to-white">
                    <h3 class="font-semibold flex items-center gap-2"><i class="ph ph-clock-counter-clockwise text-gray-400"></i> Recent Scans</h3>
                    <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500 flex items-center gap-1 transition-colors"><i class="ph ph-trash"></i> Clear</button>
                </div>
                <div class="divide-y divide-[#E9E9E7]">
                    ${state.scanHistory.slice(0, 5).map((s, i) => `
                        <div class="px-6 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors" style="animation: fadeIn 0.3s ${i * 0.1}s both">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center ${s.score > 70 ? 'bg-red-100' : s.score > 30 ? 'bg-yellow-100' : 'bg-green-100'}">
                                    <i class="ph ${s.score > 70 ? 'ph-warning text-red-600' : s.score > 30 ? 'ph-warning-circle text-yellow-600' : 'ph-check-circle text-green-600'} text-lg"></i>
                                </div>
                                <div>
                                    <span class="text-sm font-semibold">${s.type}</span>
                                    <p class="text-xs text-gray-400">${s.findings || 0} findings detected</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="text-sm font-bold ${s.score > 70 ? 'text-red-600' : s.score > 30 ? 'text-yellow-600' : 'text-green-600'}">${s.score}</span>
                                <span class="text-xs text-gray-400">${s.time}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
            ` : `
            <div class="bg-white rounded-2xl border border-[#E9E9E7] p-16 text-center">
                <div class="empty-state w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="ph ph-scan text-4xl text-gray-400"></i>
                </div>
                <h3 class="font-bold text-xl mb-2">Ready to protect your privacy?</h3>
                <p class="text-gray-500 text-sm mb-6 max-w-xs mx-auto">Start by scanning your first content. All analysis happens locally on your device.</p>
                <button onclick="router('prompt')" class="btn-primary px-6 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2">
                    <i class="ph ph-play-circle"></i> Start First Scan
                </button>
            </div>
            `}
        </div>
    `,

    Analytics: () => {
        const total = state.scanHistory.length;
        const high = state.scanHistory.filter(s => s.score > 70).length;
        const med = state.scanHistory.filter(s => s.score > 30 && s.score <= 70).length;
        const safe = state.scanHistory.filter(s => s.score <= 30).length;
        const avg = total > 0 ? Math.round(state.scanHistory.reduce((a, s) => a + s.score, 0) / total) : 0;
        const highPct = total > 0 ? Math.round((high / total) * 100) : 0;
        const medPct = total > 0 ? Math.round((med / total) * 100) : 0;
        const safePct = total > 0 ? Math.round((safe / total) * 100) : 0;
        
        // Calculate trends
        const recentScans = state.scanHistory.slice(0, 5);
        const olderScans = state.scanHistory.slice(5, 10);
        const recentAvg = recentScans.length > 0 ? Math.round(recentScans.reduce((a, s) => a + s.score, 0) / recentScans.length) : 0;
        const olderAvg = olderScans.length > 0 ? Math.round(olderScans.reduce((a, s) => a + s.score, 0) / olderScans.length) : 0;
        const trend = olderAvg > 0 ? recentAvg - olderAvg : 0;
        const trendDirection = trend > 0 ? 'up' : trend < 0 ? 'down' : 'neutral';
        
        // Get most common risk category
        const allFindings = state.scanHistory.flatMap(s => s.findings || []);
        const categoryCount = {};
        state.scanHistory.forEach(s => {
            if (s.type) categoryCount[s.type] = (categoryCount[s.type] || 0) + 1;
        });
        const topCategory = Object.entries(categoryCount).sort((a, b) => b[1] - a[1])[0];

        return `
        <div class="max-w-7xl mx-auto space-y-6 fade-in">
            <!-- Header -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">Analytics Dashboard</h1>
                    <p class="text-gray-500 mt-1">Comprehensive privacy scanning insights and trends</p>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2 px-4 py-2 bg-white rounded-xl border border-gray-200 shadow-sm">
                        <i class="ph ph-calendar text-gray-500"></i>
                        <span class="text-sm font-medium text-gray-700">Last ${total} scans</span>
                    </div>
                    <button onclick="exportAnalytics()" class="flex items-center gap-2 px-4 py-2 bg-black text-white rounded-xl text-sm font-medium hover:bg-gray-800 transition-colors">
                        <i class="ph ph-download"></i>
                        <span>Export</span>
                    </button>
                </div>
            </div>

            ${total === 0 ? `
            <!-- Empty State -->
            <div class="bg-white rounded-2xl border border-gray-200 p-16 text-center">
                <div class="w-24 h-24 bg-gradient-to-br from-gray-100 to-gray-200 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-inner">
                    <i class="ph ph-chart-line-up text-4xl text-gray-400"></i>
                </div>
                <h3 class="font-bold text-xl mb-2">No Analytics Data Yet</h3>
                <p class="text-gray-500 text-sm mb-6 max-w-md mx-auto">Start scanning content to see detailed analytics about your privacy patterns and trends.</p>
                <button onclick="router('prompt')" class="btn-primary px-6 py-3 rounded-xl text-sm font-semibold inline-flex items-center gap-2">
                    <i class="ph ph-scan"></i> Start Your First Scan
                </button>
            </div>
            ` : `
            
            <!-- Key Metrics Row -->
            <div class="grid grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Total Scans -->
                <div class="bg-white rounded-2xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2.5 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg shadow-blue-500/20">
                            <i class="ph ph-scan text-white text-lg"></i>
                        </div>
                        <span class="text-xs font-medium text-gray-400 uppercase tracking-wide">Total</span>
                    </div>
                    <p class="text-3xl font-bold text-gray-900">${total}</p>
                    <p class="text-xs text-gray-500 mt-1">Scans performed</p>
                </div>
                
                <!-- Average Score -->
                <div class="bg-white rounded-2xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2.5 bg-gradient-to-br ${avg > 70 ? 'from-red-500 to-rose-600 shadow-red-500/20' : avg > 30 ? 'from-yellow-500 to-amber-600 shadow-yellow-500/20' : 'from-green-500 to-emerald-600 shadow-green-500/20'} rounded-xl shadow-lg">
                            <i class="ph ph-gauge text-white text-lg"></i>
                        </div>
                        <div class="flex items-center gap-1">
                            ${trendDirection === 'down' ? '<i class="ph ph-trend-down text-green-500"></i><span class="text-xs text-green-600">Better</span>' : 
                              trendDirection === 'up' ? '<i class="ph ph-trend-up text-red-500"></i><span class="text-xs text-red-600">Worse</span>' : ''}
                        </div>
                    </div>
                    <p class="text-3xl font-bold ${avg > 70 ? 'text-red-600' : avg > 30 ? 'text-yellow-600' : 'text-green-600'}">${avg}</p>
                    <p class="text-xs text-gray-500 mt-1">Avg risk score</p>
                </div>
                
                <!-- High Risk -->
                <div class="bg-white rounded-2xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2.5 bg-gradient-to-br from-red-500 to-rose-600 rounded-xl shadow-lg shadow-red-500/20">
                            <i class="ph ph-warning text-white text-lg"></i>
                        </div>
                        <span class="px-2 py-0.5 bg-red-100 text-red-700 rounded-full text-xs font-bold">${highPct}%</span>
                    </div>
                    <p class="text-3xl font-bold text-red-600">${high}</p>
                    <p class="text-xs text-gray-500 mt-1">High risk scans</p>
                </div>
                
                <!-- Medium Risk -->
                <div class="bg-white rounded-2xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2.5 bg-gradient-to-br from-yellow-500 to-amber-600 rounded-xl shadow-lg shadow-yellow-500/20">
                            <i class="ph ph-warning-circle text-white text-lg"></i>
                        </div>
                        <span class="px-2 py-0.5 bg-yellow-100 text-yellow-700 rounded-full text-xs font-bold">${medPct}%</span>
                    </div>
                    <p class="text-3xl font-bold text-yellow-600">${med}</p>
                    <p class="text-xs text-gray-500 mt-1">Medium risk</p>
                </div>
                
                <!-- Safe -->
                <div class="bg-white rounded-2xl border border-gray-200 p-5 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-3">
                        <div class="p-2.5 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg shadow-green-500/20">
                            <i class="ph ph-shield-check text-white text-lg"></i>
                        </div>
                        <span class="px-2 py-0.5 bg-green-100 text-green-700 rounded-full text-xs font-bold">${safePct}%</span>
                    </div>
                    <p class="text-3xl font-bold text-green-600">${safe}</p>
                    <p class="text-xs text-gray-500 mt-1">Safe scans</p>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Privacy Score Trend -->
                <div class="lg:col-span-2 bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-gray-900">Privacy Score Trend</h3>
                            <p class="text-xs text-gray-500 mt-1">Risk scores over your last scans</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex items-center gap-1.5">
                                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                <span class="text-xs text-gray-600">Score</span>
                            </div>
                        </div>
                    </div>
                    <div class="h-64">
                        <canvas id="trend-chart"></canvas>
                    </div>
                </div>

                <!-- Risk Distribution -->
                <div class="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-gray-900">Risk Distribution</h3>
                            <p class="text-xs text-gray-500 mt-1">Breakdown by severity</p>
                        </div>
                    </div>
                    <div class="h-48">
                        <canvas id="risk-chart"></canvas>
                    </div>
                    <div class="flex justify-center gap-4 mt-4">
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-red-500"></div>
                            <span class="text-xs text-gray-600">High</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
                            <span class="text-xs text-gray-600">Medium</span>
                        </div>
                        <div class="flex items-center gap-1.5">
                            <div class="w-3 h-3 rounded-full bg-green-500"></div>
                            <span class="text-xs text-gray-600">Safe</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Second Row -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Scan Types Distribution -->
                <div class="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="font-bold text-gray-900">Scan Types</h3>
                            <p class="text-xs text-gray-500 mt-1">Distribution by scanner</p>
                        </div>
                    </div>
                    <div class="h-48">
                        <canvas id="type-chart"></canvas>
                    </div>
                </div>

                <!-- Privacy Score Gauge -->
                <div class="bg-gradient-to-br ${avg > 70 ? 'from-red-500 to-rose-600' : avg > 30 ? 'from-yellow-500 to-amber-600' : 'from-green-500 to-emerald-600'} rounded-2xl p-6 text-white hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold">Privacy Health Score</h3>
                        <i class="ph ph-heart-half text-2xl opacity-80"></i>
                    </div>
                    <div class="flex items-center justify-center my-6">
                        <div class="relative">
                            <svg class="w-36 h-36 transform -rotate-90">
                                <circle cx="72" cy="72" r="60" fill="none" stroke="rgba(255,255,255,0.2)" stroke-width="12"/>
                                <circle cx="72" cy="72" r="60" fill="none" stroke="white" stroke-width="12" 
                                    stroke-dasharray="${(100 - avg) * 3.77} 377" stroke-linecap="round"/>
                            </svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-4xl font-black">${100 - avg}</span>
                                <span class="text-xs opacity-80">/ 100</span>
                            </div>
                        </div>
                    </div>
                    <p class="text-center text-sm opacity-90">
                        ${avg <= 30 ? 'Excellent! Your privacy practices are strong.' : 
                          avg <= 70 ? 'Good, but there\'s room for improvement.' : 
                          'Needs attention. Review your content carefully.'}
                    </p>
                </div>

                <!-- Quick Insights -->
                <div class="bg-white rounded-2xl border border-gray-200 p-6 hover:shadow-lg transition-shadow">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="font-bold text-gray-900">Quick Insights</h3>
                        <i class="ph ph-lightbulb text-yellow-500 text-xl"></i>
                    </div>
                    <div class="space-y-3">
                        ${topCategory ? `
                        <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-xl">
                            <div class="p-2 bg-blue-100 rounded-lg">
                                <i class="ph ph-chart-pie text-blue-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-blue-900">Most Used Scanner</p>
                                <p class="text-xs text-blue-700">${topCategory[0]} (${topCategory[1]} scans)</p>
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="flex items-center gap-3 p-3 ${trend < 0 ? 'bg-green-50' : trend > 0 ? 'bg-red-50' : 'bg-gray-50'} rounded-xl">
                            <div class="p-2 ${trend < 0 ? 'bg-green-100' : trend > 0 ? 'bg-red-100' : 'bg-gray-100'} rounded-lg">
                                <i class="ph ${trend < 0 ? 'ph-trend-down text-green-600' : trend > 0 ? 'ph-trend-up text-red-600' : 'ph-minus text-gray-600'}"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium ${trend < 0 ? 'text-green-900' : trend > 0 ? 'text-red-900' : 'text-gray-900'}">Risk Trend</p>
                                <p class="text-xs ${trend < 0 ? 'text-green-700' : trend > 0 ? 'text-red-700' : 'text-gray-700'}">
                                    ${trend < 0 ? `Improved by ${Math.abs(trend)} points` : trend > 0 ? `Increased by ${trend} points` : 'Staying consistent'}
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-xl">
                            <div class="p-2 bg-purple-100 rounded-lg">
                                <i class="ph ph-clock text-purple-600"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-purple-900">Last Scan</p>
                                <p class="text-xs text-purple-700">${state.scanHistory[0]?.time || 'N/A'} - Score: ${state.scanHistory[0]?.score || 0}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Table -->
            <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:shadow-lg transition-shadow">
                <div class="px-6 py-4 border-b border-gray-100 flex items-center justify-between bg-gradient-to-r from-gray-50 to-white">
                    <div>
                        <h3 class="font-bold text-gray-900">Recent Scan Activity</h3>
                        <p class="text-xs text-gray-500 mt-0.5">Your latest privacy scans</p>
                    </div>
                    <button onclick="clearHistory()" class="text-xs text-gray-400 hover:text-red-500 flex items-center gap-1 transition-colors px-3 py-1.5 rounded-lg hover:bg-red-50">
                        <i class="ph ph-trash"></i> Clear All
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Findings</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Time</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            ${state.scanHistory.slice(0, 10).map((scan, idx) => `
                                <tr class="hover:bg-gray-50 transition-colors" style="animation: fadeIn 0.3s ${idx * 0.05}s both">
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg flex items-center justify-center ${
                                                scan.type === 'Prompt' ? 'bg-violet-100 text-violet-600' :
                                                scan.type === 'Email' ? 'bg-orange-100 text-orange-600' :
                                                scan.type === 'Website' ? 'bg-cyan-100 text-cyan-600' :
                                                'bg-pink-100 text-pink-600'
                                            }">
                                                <i class="ph ${
                                                    scan.type === 'Prompt' ? 'ph-robot' :
                                                    scan.type === 'Email' ? 'ph-envelope' :
                                                    scan.type === 'Website' ? 'ph-globe' :
                                                    'ph-user-focus'
                                                }"></i>
                                            </div>
                                            <span class="font-medium text-sm text-gray-900">${scan.type}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <div class="flex items-center gap-2">
                                            <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                                                <div class="h-full rounded-full ${scan.score > 70 ? 'bg-red-500' : scan.score > 30 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${scan.score}%"></div>
                                            </div>
                                            <span class="text-sm font-bold ${scan.score > 70 ? 'text-red-600' : scan.score > 30 ? 'text-yellow-600' : 'text-green-600'}">${scan.score}</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="px-2.5 py-1 rounded-full text-xs font-semibold ${
                                            scan.score > 70 ? 'bg-red-100 text-red-700' :
                                            scan.score > 30 ? 'bg-yellow-100 text-yellow-700' :
                                            'bg-green-100 text-green-700'
                                        }">
                                            ${scan.score > 70 ? 'High Risk' : scan.score > 30 ? 'Caution' : 'Safe'}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-sm text-gray-600">${scan.findings || 0} found</span>
                                    </td>
                                    <td class="px-6 py-4">
                                        <span class="text-sm text-gray-500">${scan.time}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
            
            `}
        </div>
        `;
    },

    Scanner: (type, title, desc, icon) => {
        const isComparison = state.settings.ui.comparison;
        const iconColors = {
            'ph-robot': 'from-violet-500 to-purple-600',
            'ph-envelope-simple-open': 'from-orange-500 to-amber-600',
            'ph-globe': 'from-cyan-500 to-blue-600',
            'ph-user-focus': 'from-pink-500 to-rose-600'
        };
        const iconColor = iconColors[icon] || 'from-gray-500 to-gray-600';
        
        return `
        <div class="max-w-${isComparison ? '6xl' : '3xl'} mx-auto fade-in">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center gap-4">
                    <div class="p-3 bg-gradient-to-br ${iconColor} rounded-2xl shadow-lg shadow-gray-500/10">
                        <i class="ph ${icon} text-2xl text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold bg-gradient-to-r from-gray-900 to-gray-600 bg-clip-text text-transparent">${title}</h1>
                        <p class="text-gray-500 text-sm">${desc}</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="loadExample('${type}')" class="px-4 py-2 text-sm font-medium border-2 border-gray-200 rounded-xl hover:border-gray-400 hover:bg-gray-50 flex items-center gap-2 transition-all">
                        <i class="ph ph-flask text-purple-500"></i> Try Example
                    </button>
                    <button onclick="toggleSettings()" class="p-2.5 hover:bg-gray-100 rounded-xl border border-gray-200 transition-colors" title="Settings">
                        <i class="ph ph-gear text-xl text-gray-600"></i>
                    </button>
                </div>
            </div>

            <div class="${isComparison ? 'grid grid-cols-2 gap-6' : ''}">
                <div class="bg-white rounded-2xl border border-[#E9E9E7] shadow-sm overflow-hidden mb-6 hover:shadow-md transition-shadow">
                    ${isComparison ? '<div class="px-4 py-2.5 bg-gradient-to-r from-gray-50 to-white border-b text-xs font-bold text-gray-500 uppercase tracking-wider">Original Input</div>' : ''}
                    <textarea id="scan-input" 
                        class="w-full p-6 min-h-[280px] resize-none outline-none text-sm font-mono leading-relaxed placeholder:text-gray-300" 
                        placeholder="Paste your content here to analyze for privacy risks..."
                        oninput="handleInput()"></textarea>
                    <div class="px-6 py-4 bg-gradient-to-r from-gray-50 to-white border-t border-[#E9E9E7] flex justify-between items-center">
                        <div class="flex gap-5 text-xs text-gray-400">
                            <span class="flex items-center gap-1.5"><i class="ph ph-lock-key text-green-500"></i> Local Only</span>
                            <span class="flex items-center gap-1.5"><i class="ph ph-text-aa"></i> <span id="char-count">0 chars</span></span>
                        </div>
                        <button onclick="runScan('${type}')" class="btn-primary px-5 py-2.5 text-sm font-semibold flex items-center gap-2">
                            <i class="ph ph-scan"></i> Analyze Risk
                        </button>
                    </div>
                </div>

                ${isComparison ? `
                <div class="bg-white rounded-2xl border border-[#E9E9E7] shadow-sm overflow-hidden mb-6 hover:shadow-md transition-shadow">
                    <div class="px-4 py-2.5 bg-gradient-to-r from-green-50 to-emerald-50 border-b border-green-100 text-xs font-bold text-green-700 uppercase tracking-wider flex items-center gap-2">
                        <i class="ph ph-shield-check"></i> Redacted Output (Safe to Share)
                    </div>
                    <div id="comparison-output" class="w-full p-6 min-h-[280px] text-sm font-mono text-gray-600 whitespace-pre-wrap leading-relaxed bg-gradient-to-br from-white to-green-50/30">
                        <span class="text-gray-400 italic">Run a scan to see the safe version...</span>
                    </div>
                </div>
                ` : ''}
            </div>

            <div id="results-area"></div>
        </div>
        `;
    },

    ResultsCard: (result) => `
        <div class="result-card ${result.score > 70 ? 'danger' : result.score > 30 ? 'warning' : 'safe'} fade-in">
            <div class="p-8 border-b border-gray-200 dark:border-current dark:border-opacity-10 flex items-center justify-between">
                <div>
                    <p class="text-xs font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider mb-2 opacity-75">Risk Score</p>
                    <div class="flex items-baseline gap-3">
                        <span class="text-6xl font-black ${result.color}">${result.score}</span>
                        <span class="text-lg text-gray-500 dark:text-gray-400 font-light opacity-75">/100</span>
                    </div>
                    <div class="mt-4">
                        <span class="inline-block px-4 py-2 rounded-full text-xs font-semibold ${result.score > 70 ? 'bg-red-100 text-red-900 border border-red-300 dark:bg-red-950/30 dark:text-red-200 dark:border-red-800' : result.score > 30 ? 'bg-yellow-100 text-yellow-900 border border-yellow-300 dark:bg-yellow-950/30 dark:text-yellow-200 dark:border-yellow-800' : 'bg-green-100 text-green-900 border border-green-300 dark:bg-green-950/30 dark:text-green-200 dark:border-green-800'}">${result.status}</span>
                    </div>
                </div>
                <div class="score-display">
                    <div class="score-ring ${result.score > 70 ? 'border-red-500/30' : result.score > 30 ? 'border-yellow-500/30' : 'border-green-500/30'}"></div>
                    <div class="w-20 h-20 rounded-full flex items-center justify-center ${result.score > 70 ? 'bg-gradient-to-br from-red-50 to-red-100 dark:from-red-950/40 dark:to-red-900/40' : result.score > 30 ? 'bg-gradient-to-br from-yellow-50 to-yellow-100 dark:from-yellow-950/40 dark:to-yellow-900/40' : 'bg-gradient-to-br from-green-50 to-green-100 dark:from-green-950/40 dark:to-green-900/40'} shadow-lg">
                        <i class="ph ${result.score > 70 ? 'ph-warning' : result.score > 30 ? 'ph-warning-circle' : 'ph-check-circle'} text-5xl ${result.color}"></i>
                    </div>
                </div>
            </div>

            ${result.findings.length > 0 ? `
            <div class="px-6 py-4 bg-green-50 dark:bg-green-950/20 border-b border-green-200 dark:border-green-900/30">
                <div class="flex items-center justify-between mb-3">
                    <span class="text-sm font-semibold text-green-800 dark:text-green-100 flex items-center gap-2"><i class="ph ph-check-circle"></i> Safe Version</span>
                    <button onclick="copyRedacted()" class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1.5">
                        <i class="ph ph-copy"></i> Copy
                    </button>
                </div>
                <div class="p-3 rounded-lg bg-white border border-green-200 dark:bg-zinc-900 dark:border-green-900/30 text-xs font-mono text-gray-700 dark:text-gray-300 leading-relaxed max-h-40 overflow-y-auto">${escapeHtml(result.redactedText)}</div>
            </div>

            <div class="px-6 py-4 border-b border-gray-200 dark:border-current dark:border-opacity-10 flex flex-wrap gap-2">
                <button onclick="copyRedacted()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="ph ph-copy"></i> Copy Safe
                </button>
                <button onclick="quickFixAll()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <i class="ph ph-magic-wand"></i> Auto-fix
                </button>
                <button onclick="copyAsMarkdown()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center gap-2">
                    <i class="ph ph-file-text"></i> Markdown
                </button>
                <button onclick="copyAsJSON()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center gap-2">
                    <i class="ph ph-brackets-curly"></i> JSON
                </button>
                <button onclick="exportReport()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors flex items-center gap-2">
                    <i class="ph ph-file-html"></i> Export
                </button>
            </div>
            ` : ''}

            <div class="p-6">
                <h4 class="font-semibold mb-6 flex items-center gap-2 text-sm text-gray-900 dark:text-white">
                    <i class="ph ph-list-magnifying-glass text-lg"></i> 
                    Findings
                    <span class="inline-flex items-center justify-center w-6 h-6 text-xs font-bold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-full ml-2">${result.findings.length}</span>
                </h4>

                ${result.findings.length === 0 ? `
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-green-100 dark:bg-green-950/30 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="ph ph-check-circle text-4xl text-green-600 dark:text-green-400"></i>
                        </div>
                        <p class="font-semibold text-green-700 dark:text-green-300 mb-1">No Risks Found</p>
                        <p class="text-sm opacity-75">Your content appears to be safe to share</p>
                    </div>
                ` : `
                    <div class="space-y-3">
                        ${Object.entries(result.groupedFindings).map(([cat, items]) => {
                            const catInfo = {
                                pii: { name: 'Personal Information', icon: 'ph-user', color: 'border-red-500', bg: 'bg-red-50' },
                                credentials: { name: 'Credentials', icon: 'ph-key', color: 'border-purple-500', bg: 'bg-purple-50' },
                                scam: { name: 'Scam Indicators', icon: 'ph-warning', color: 'border-yellow-500', bg: 'bg-yellow-50' },
                                corporate: { name: 'Corporate Data', icon: 'ph-briefcase', color: 'border-blue-500', bg: 'bg-blue-50' },
                                compliance: { name: 'Compliance', icon: 'ph-scales', color: 'border-orange-500', bg: 'bg-orange-50' }
                            }[cat] || { name: cat, icon: 'ph-info', color: 'border-gray-500', bg: 'bg-gray-50' };

                            return `
                                <div class="category-section category-${cat} rounded-xl overflow-hidden mb-3 last:mb-0" data-category="${cat}">
                                    <div class="category-header p-4 font-semibold text-sm text-gray-900 dark:text-white flex items-center justify-between cursor-pointer transition-all" onclick="toggleCategory('${cat}')">
                                        <div class="flex items-center gap-3">
                                            <i class="ph ${catInfo.icon} text-lg"></i>
                                            <span>${catInfo.name}</span>
                                            <span class="inline-flex items-center justify-center w-6 h-6 text-xs font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg">${items.length}</span>
                                        </div>
                                        <i class="ph ph-caret-down category-toggle text-lg"></i>
                                    </div>
                                    <div class="category-body divide-y divide-current divide-opacity-10">
                                        ${items.map(f => `
                                            <div class="finding-item">
                                                <div class="flex-1 min-w-0">
                                                    <div class="flex items-center gap-2 mb-2">
                                                        <span class="font-semibold text-sm text-gray-900 dark:text-white">${f.name}</span>
                                                        <span class="confidence-${f.confidence}">${f.confidence}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">${f.desc}</p>
                                                    ${f.value ? `<div class="finding-value">${escapeHtml(f.value)}</div>` : ''}
                                                </div>
                                                <button onclick="addToWhitelist('${escapeHtml(f.value || f.name)}')" class="btn-whitelist p-2 rounded-lg flex-shrink-0" title="Add to whitelist">
                                                    <i class="ph ph-plus text-lg"></i>
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>

            ${result.findings.length > 0 ? `
            <div class="px-6 py-6 border-t border-current border-opacity-10">
                <h4 class="font-semibold mb-4 flex items-center gap-2 text-sm">
                    <i class="ph ph-code-block"></i> Source with Highlights
                </h4>
                <div class="p-4 rounded-lg bg-gray-900 dark:bg-zinc-950 text-amber-100 dark:text-amber-100 text-xs font-mono leading-relaxed overflow-x-auto max-h-96">${result.highlightedText}</div>
            </div>
            ` : ''}
        </div>
    `
};

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// =============================================
// ROUTER & ACTIONS
// =============================================
function router(view) {
    state.currentView = view;
    const container = document.getElementById('app-container');

    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`nav-${view}`)?.classList.add('active');

    switch(view) {
        case 'dashboard':
            container.innerHTML = Components.Dashboard();
            break;
        case 'analytics':
            container.innerHTML = Components.Analytics();
            setTimeout(initCharts, 100);
            break;
        case 'prompt':
            container.innerHTML = Components.Scanner('prompt', 'AI Prompt Checker', 'Check prompts before sending to LLMs', 'ph-robot');
            break;
        case 'email':
            container.innerHTML = Components.Scanner('email', 'Email & Scam Detector', 'Analyze emails for phishing and fraud', 'ph-envelope-simple-open');
            break;
        case 'website':
            container.innerHTML = Components.Scanner('website', 'Website Audit', 'Check URLs for tracking and security issues', 'ph-globe');
            break;
        case 'exposure':
            container.innerHTML = Components.Scanner('exposure', 'Content Exposure', 'Detect identity exposure in posts and bios', 'ph-user-focus');
            break;
        default:
            container.innerHTML = Components.Dashboard();
    }

    saveState();
}

function runScan(type) {
    const input = document.getElementById('scan-input');
    const text = input?.value || '';

    if (!text.trim()) {
        showToast('Please enter content to analyze', 'error');
        return;
    }

    // Save to undo stack
    state.undoStack.push({ text, type });
    state.redoStack = [];

    const result = analyzeText(text, type);
    state.lastScanResult = result;

    // Update stats
    state.stats.scans++;
    if (result.findings.length > 0) state.stats.risksFound++;

    // Add to history
    state.scanHistory.unshift({
        type: type.charAt(0).toUpperCase() + type.slice(1),
        score: result.score,
        findings: result.findings.length,
        time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
        timestamp: Date.now()
    });
    state.scanHistory = state.scanHistory.slice(0, 50);

    saveState();

    // Update comparison output if enabled
    if (state.settings.ui.comparison) {
        document.getElementById('comparison-output').textContent = result.redactedText;
    }

    // Show results
    document.getElementById('results-area').innerHTML = Components.ResultsCard(result);

    // Celebration for safe scans
    if (result.score === 0) {
        triggerConfetti();
        showToast('Perfect! No risks detected! ', 'success');
    } else {
        showToast(`Analysis complete: ${result.findings.length} findings`, 'info');
    }
}

function handleInput() {
    const input = document.getElementById('scan-input');
    const text = input?.value || '';
    
    // Update char count
    document.getElementById('char-count').textContent = `${text.length} chars`;

    // Real-time risk indicator
    if (state.settings.ui.realtime && text.length > 10) {
        const result = analyzeText(text);
        const indicator = document.getElementById('realtime-indicator');
        const scoreLive = document.getElementById('risk-score-live');
        const dot = document.getElementById('risk-dot');
        const wordCount = document.getElementById('word-count');

        indicator.classList.add('active');
        scoreLive.textContent = result.score;
        scoreLive.className = `text-sm font-bold ${result.color}`;
        dot.className = `w-3 h-3 rounded-full ${result.score > 70 ? 'bg-red-500' : result.score > 30 ? 'bg-yellow-500' : 'bg-green-500'}`;
        wordCount.textContent = `${text.split(/\s+/).filter(w => w).length} words`;
    } else {
        document.getElementById('realtime-indicator').classList.remove('active');
    }
}

function loadExample(type) {
    const input = document.getElementById('scan-input');
    if (input) {
        input.value = demoExamples[type] || '';
        handleInput();
        showToast('Example loaded! Click Analyze to scan.', 'success');
    }
}

// =============================================
// HELPER FUNCTIONS
// =============================================
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    const styles = {
        success: 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-green-500/25',
        error: 'bg-gradient-to-r from-red-500 to-rose-600 text-white shadow-red-500/25',
        info: 'bg-gradient-to-r from-gray-800 to-gray-900 text-white shadow-gray-900/25'
    };
    const icons = {
        success: 'ph-check-circle',
        error: 'ph-x-circle',
        info: 'ph-info'
    };
    toast.className = `toast px-5 py-3.5 rounded-xl shadow-2xl text-sm font-medium ${styles[type]} flex items-center gap-3 backdrop-blur-sm border border-white/10`;
    toast.innerHTML = `
        <i class="ph ${icons[type]} text-lg"></i>
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="ml-2 opacity-60 hover:opacity-100 transition-opacity">
            <i class="ph ph-x text-sm"></i>
        </button>
    `;
    container.appendChild(toast);
    setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s reverse forwards';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function triggerConfetti() {
    const colors = ['#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#F59E0B', '#EF4444'];
    const shapes = ['square', 'circle'];
    const container = document.getElementById('confetti-container');
    
    for (let i = 0; i < 80; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 1.5 + 's';
        confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
        confetti.style.width = (Math.random() * 8 + 6) + 'px';
        confetti.style.height = (Math.random() * 8 + 6) + 'px';
        confetti.style.borderRadius = shapes[Math.floor(Math.random() * shapes.length)] === 'circle' ? '50%' : '2px';
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        container.appendChild(confetti);
        setTimeout(() => confetti.remove(), 4000);
    }
}

function copyRedacted() {
    if (!state.lastScanResult) return;
    navigator.clipboard.writeText(state.lastScanResult.redactedText);
    showToast('Redacted text copied!', 'success');
}

function quickFixAll() {
    if (!state.lastScanResult) return;
    const input = document.getElementById('scan-input');
    if (input) {
        input.value = state.lastScanResult.redactedText;
        handleInput();
        showToast('Content fixed! Review and scan again.', 'success');
    }
}

function copyAsMarkdown() {
    if (!state.lastScanResult) return;
    const r = state.lastScanResult;
    const md = `# Privacy Scan Report\n\n**Score:** ${r.score}/100\n**Status:** ${r.status}\n\n## Findings\n\n${r.findings.map(f => `- **${f.name}**: ${f.desc}`).join('\n')}`;
    navigator.clipboard.writeText(md);
    showToast('Copied as Markdown!', 'success');
}

function copyAsJSON() {
    if (!state.lastScanResult) return;
    navigator.clipboard.writeText(JSON.stringify(state.lastScanResult, null, 2));
    showToast('Copied as JSON!', 'success');
}

function exportReport() {
    if (!state.lastScanResult) return;
    const r = state.lastScanResult;
    const html = `<!DOCTYPE html><html><head><title>Privacy Report</title><style>body{font-family:sans-serif;max-width:800px;margin:40px auto;padding:20px}h1{color:#333}.finding{padding:10px;margin:10px 0;background:#f5f5f5;border-left:4px solid #ff4444}</style></head><body><h1>Privacy Scan Report</h1><p><strong>Score:</strong> ${r.score}/100</p><p><strong>Status:</strong> ${r.status}</p><h2>Findings (${r.findings.length})</h2>${r.findings.map(f => `<div class="finding"><strong>${f.name}</strong><br>${f.desc}</div>`).join('')}</body></html>`;
    const blob = new Blob([html], { type: 'text/html' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'privacy-report.html';
    a.click();
    showToast('Report exported!', 'success');
}

function toggleCategory(cat) {
    document.querySelector(`.category-section[data-category="${cat}"]`)?.classList.toggle('collapsed');
}

function addToWhitelist(value) {
    if (!value || state.settings.whitelist.includes(value)) return;
    state.settings.whitelist.push(value);
    saveState();
    updateWhitelistUI();
    showToast('Added to whitelist', 'success');
}

function removeFromWhitelist(value) {
    state.settings.whitelist = state.settings.whitelist.filter(w => w !== value);
    saveState();
    updateWhitelistUI();
    showToast('Removed from whitelist', 'success');
}

function updateWhitelistUI() {
    const container = document.getElementById('whitelist-items');
    if (!container) return;
    if (state.settings.whitelist.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic">No whitelisted items</p>';
    } else {
        container.innerHTML = state.settings.whitelist.map(w => `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs">
                <code class="truncate flex-1">${escapeHtml(w)}</code>
                <button onclick="removeFromWhitelist('${escapeHtml(w)}')" class="text-red-500 hover:text-red-700 ml-2"><i class="ph ph-x"></i></button>
            </div>
        `).join('');
    }
}

function clearHistory() {
    if (confirm('Clear all scan history?')) {
        state.scanHistory = [];
        state.stats = { scans: 0, risksFound: 0 };
        saveState();
        router(state.currentView);
        showToast('History cleared', 'success');
    }
}

function undo() {
    if (state.undoStack.length === 0) return;
    const last = state.undoStack.pop();
    state.redoStack.push({ text: document.getElementById('scan-input')?.value || '', type: state.currentView });
    const input = document.getElementById('scan-input');
    if (input) input.value = last.text;
    showToast('Undone', 'info');
}

function redo() {
    if (state.redoStack.length === 0) return;
    const next = state.redoStack.pop();
    state.undoStack.push({ text: document.getElementById('scan-input')?.value || '', type: state.currentView });
    const input = document.getElementById('scan-input');
    if (input) input.value = next.text;
    showToast('Redone', 'info');
}

// =============================================
// SETTINGS
// =============================================
function toggleSettings() {
    document.getElementById('settings-panel').classList.toggle('open');
    document.getElementById('settings-backdrop').classList.toggle('open');
    updateWhitelistUI();
    updateCustomPatternsUI();
}

function toggleDarkMode() {
    state.settings.ui.darkMode = document.getElementById('toggle-dark-mode').checked;
    document.documentElement.setAttribute('data-theme', state.settings.ui.darkMode ? 'dark' : 'light');
    saveState();
}

function toggleRealtime() {
    state.settings.ui.realtime = document.getElementById('toggle-realtime').checked;
    saveState();
}

function toggleComparisonMode() {
    state.settings.ui.comparison = document.getElementById('toggle-comparison').checked;
    saveState();
    if (['prompt', 'email', 'website', 'exposure'].includes(state.currentView)) {
        const text = document.getElementById('scan-input')?.value || '';
        router(state.currentView);
        setTimeout(() => {
            const input = document.getElementById('scan-input');
            if (input) input.value = text;
        }, 50);
    }
}

function setScanPreset(preset) {
    state.settings.scanPreset = preset;
    // Remove border-black from all presets and add border-gray-200
    document.querySelectorAll('[id^="preset-"]').forEach(el => {
        el.classList.remove('border-black');
        el.classList.add('border-gray-200');
    });
    // Add border-black to selected preset
    const selected = document.getElementById(`preset-${preset}`);
    if (selected) {
        selected.classList.remove('border-gray-200');
        selected.classList.add('border-black');
    }
    saveState();
    showToast(`Scan preset: ${preset}`, 'success');
}

function updateCategories() {
    state.settings.categories = {
        pii: document.getElementById('toggle-pii').checked,
        credentials: document.getElementById('toggle-credentials').checked,
        scam: document.getElementById('toggle-scam').checked,
        corporate: document.getElementById('toggle-corporate').checked,
        compliance: document.getElementById('toggle-compliance').checked
    };
    saveState();
}

function toggleEncryption() {
    state.settings.security.encryption = document.getElementById('toggle-encryption').checked;
    saveState();
    showToast(state.settings.security.encryption ? 'Encryption enabled' : 'Encryption disabled', 'success');
}

function toggleSessionOnly() {
    state.settings.security.sessionOnly = document.getElementById('toggle-session').checked;
    if (state.settings.security.sessionOnly) {
        localStorage.removeItem('privacyguard');
    }
    saveState();
    showToast(state.settings.security.sessionOnly ? 'Session-only mode' : 'Data will persist', 'success');
}

function setAutoDelete() {
    state.settings.security.autoDeleteDays = parseInt(document.getElementById('auto-delete-days').value);
    saveState();
}

function exportAllData() {
    const data = { ...state, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `privacyguard-export-${Date.now()}.json`;
    a.click();
    showToast('Data exported!', 'success');
}

function confirmClearAll() {
    if (confirm('Delete ALL data? This cannot be undone.')) {
        localStorage.removeItem('privacyguard');
        sessionStorage.removeItem('privacyguard');
        location.reload();
    }
}

// Custom Patterns
function showPatternWizard() {
    document.getElementById('pattern-wizard-overlay').classList.add('active');
    document.getElementById('pattern-wizard-content').innerHTML = `
        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-1">Pattern Name</label>
                <input type="text" id="pattern-name" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="e.g., Company Email">
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Regex Pattern</label>
                <input type="text" id="pattern-regex" class="w-full border rounded-lg px-3 py-2 text-sm font-mono" placeholder="e.g., @mycompany\\.com">
                <p class="text-xs text-gray-500 mt-1">JavaScript regex syntax</p>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Category</label>
                <select id="pattern-category" class="w-full border rounded-lg px-3 py-2 text-sm">
                    <option value="pii">Personal Information</option>
                    <option value="credentials">Credentials</option>
                    <option value="corporate">Corporate</option>
                    <option value="scam">Scam</option>
                    <option value="compliance">Compliance</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Risk Level: <span id="risk-value">50</span></label>
                <input type="range" id="pattern-risk" min="10" max="100" value="50" class="w-full" oninput="document.getElementById('risk-value').textContent=this.value">
            </div>
            <div class="flex gap-2 pt-4">
                <button onclick="saveCustomPattern()" class="flex-1 bg-black text-white py-2 rounded-lg text-sm hover:bg-gray-800">Save Pattern</button>
                <button onclick="closePatternWizard()" class="flex-1 border py-2 rounded-lg text-sm hover:bg-gray-50">Cancel</button>
            </div>
        </div>
    `;
}

function closePatternWizard() {
    document.getElementById('pattern-wizard-overlay').classList.remove('active');
}

function saveCustomPattern() {
    const name = document.getElementById('pattern-name').value.trim();
    const regex = document.getElementById('pattern-regex').value.trim();
    const category = document.getElementById('pattern-category').value;
    const risk = parseInt(document.getElementById('pattern-risk').value);

    if (!name || !regex) {
        showToast('Name and regex required', 'error');
        return;
    }

    try {
        new RegExp(regex);
    } catch (e) {
        showToast('Invalid regex pattern', 'error');
        return;
    }

    state.settings.customPatterns.push({ name, regex, category, risk, confidence: 'medium', desc: `Custom: ${name}` });
    saveState();
    closePatternWizard();
    updateCustomPatternsUI();
    showToast('Pattern saved!', 'success');
}

function updateCustomPatternsUI() {
    const container = document.getElementById('custom-patterns-list');
    if (!container) return;
    if (state.settings.customPatterns.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic">No custom patterns yet</p>';
    } else {
        container.innerHTML = state.settings.customPatterns.map((p, i) => `
            <div class="flex items-center justify-between p-2 bg-gray-50 rounded text-xs">
                <div>
                    <span class="font-medium">${escapeHtml(p.name)}</span>
                    <code class="ml-2 text-gray-500">${escapeHtml(p.regex.substring(0, 20))}...</code>
                </div>
                <button onclick="removeCustomPattern(${i})" class="text-red-500 hover:text-red-700"><i class="ph ph-x"></i></button>
            </div>
        `).join('');
    }
}

function removeCustomPattern(index) {
    state.settings.customPatterns.splice(index, 1);
    saveState();
    updateCustomPatternsUI();
    showToast('Pattern removed', 'success');
}

// =============================================
// CHARTS
// =============================================
function initCharts() {
    const total = state.scanHistory.length;
    if (total === 0) return;

    const high = state.scanHistory.filter(s => s.score > 70).length;
    const med = state.scanHistory.filter(s => s.score > 30 && s.score <= 70).length;
    const safe = state.scanHistory.filter(s => s.score <= 30).length;

    // Destroy existing charts if any
    Chart.helpers.each(Chart.instances, (instance) => {
        instance.destroy();
    });

    // Risk Distribution Chart (Doughnut)
    const riskCtx = document.getElementById('risk-chart')?.getContext('2d');
    if (riskCtx) {
        new Chart(riskCtx, {
            type: 'doughnut',
            data: {
                labels: ['High Risk', 'Medium', 'Safe'],
                datasets: [{
                    data: [high, med, safe],
                    backgroundColor: ['#EF4444', '#F59E0B', '#22C55E'],
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: true,
                        boxPadding: 4
                    }
                }
            }
        });
    }

    // Type Distribution (Pie)
    const types = state.scanHistory.reduce((acc, s) => { acc[s.type] = (acc[s.type] || 0) + 1; return acc; }, {});
    const typeCtx = document.getElementById('type-chart')?.getContext('2d');
    if (typeCtx) {
        new Chart(typeCtx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(types),
                datasets: [{
                    data: Object.values(types),
                    backgroundColor: ['#8B5CF6', '#F97316', '#06B6D4', '#EC4899'],
                    borderWidth: 0,
                    hoverBorderWidth: 2,
                    hoverBorderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'circle',
                            padding: 15,
                            font: { size: 11 }
                        }
                    },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        });
    }

    // Trend Chart (Line with gradient)
    const last10 = state.scanHistory.slice(0, 10).reverse();
    const trendCtx = document.getElementById('trend-chart')?.getContext('2d');
    if (trendCtx && last10.length > 0) {
        const gradient = trendCtx.createLinearGradient(0, 0, 0, 250);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: last10.map((s, i) => s.time || `#${i + 1}`),
                datasets: [{
                    label: 'Risk Score',
                    data: last10.map(s => s.score),
                    borderColor: '#3B82F6',
                    backgroundColor: gradient,
                    fill: true,
                    tension: 0.4,
                    borderWidth: 3,
                    pointBackgroundColor: '#3B82F6',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        grid: {
                            color: 'rgba(0,0,0,0.05)',
                            drawBorder: false
                        },
                        ticks: {
                            font: { size: 11 },
                            color: '#9CA3AF',
                            padding: 10
                        }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 11 },
                            color: '#9CA3AF',
                            maxRotation: 0
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#1f2937',
                        titleFont: { size: 13, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            title: (items) => `Scan: ${items[0].label}`,
                            label: (item) => `Risk Score: ${item.raw}`
                        }
                    }
                }
            }
        });
    }
}

// Export analytics as CSV
function exportAnalytics() {
    const headers = ['Type', 'Score', 'Status', 'Findings', 'Time'];
    const rows = state.scanHistory.map(s => [
        s.type,
        s.score,
        s.score > 70 ? 'High Risk' : s.score > 30 ? 'Caution' : 'Safe',
        s.findings || 0,
        s.time
    ]);
    
    const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `privacyguard-analytics-${Date.now()}.csv`;
    a.click();
    showToast('Analytics exported as CSV!', 'success');
}

// =============================================
// MOBILE & KEYBOARD
// =============================================
function toggleMobileMenu() {
    const sidebar = document.getElementById('sidebar');
    const backdrop = document.getElementById('mobile-backdrop');
    sidebar.classList.toggle('hidden');
    backdrop.classList.toggle('active');
}

function toggleShortcuts() {
    document.getElementById('shortcuts-panel').classList.toggle('active');
}

// Keyboard shortcuts
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        document.getElementById('settings-panel').classList.remove('open');
        document.getElementById('settings-backdrop').classList.remove('open');
        document.getElementById('shortcuts-panel').classList.remove('active');
        document.getElementById('pattern-wizard-overlay').classList.remove('active');
        document.getElementById('onboarding-overlay').classList.remove('active');
    }
    if (e.key === '?' && !e.ctrlKey) toggleShortcuts();
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        const type = state.currentView;
        if (['prompt', 'email', 'website', 'exposure'].includes(type)) runScan(type);
    }
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') { e.preventDefault(); copyRedacted(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'd') { e.preventDefault(); document.getElementById('toggle-dark-mode').click(); }
    if ((e.ctrlKey || e.metaKey) && e.key === ',') { e.preventDefault(); toggleSettings(); }
    if ((e.ctrlKey || e.metaKey) && e.key === 'z') { e.preventDefault(); undo(); }
});

// =============================================
// ONBOARDING
// =============================================
const onboardingSteps = [
    { title: 'Welcome to PrivacyGuard AI! ', desc: 'Scan your content for sensitive data, scams, and privacy risks - all locally on your device.', icon: 'ph-shield-check' },
    { title: 'Choose a Scanner', desc: 'Use AI Prompt Check, Email Scanner, Website Audit, or Exposure Analyzer for different content types.', icon: 'ph-scan' },
    { title: 'Stay Safe, Stay Private', desc: 'Your data never leaves your browser. All scanning happens 100% locally.', icon: 'ph-lock-key' }
];
let onboardingStep = 0;

function showOnboarding() {
    if (state.onboardingComplete) return;
    document.getElementById('onboarding-overlay').classList.add('active');
    renderOnboardingStep();
}

function renderOnboardingStep() {
    const step = onboardingSteps[onboardingStep];
    document.getElementById('onboarding-content').innerHTML = `
        <div class="w-20 h-20 bg-black rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="ph ${step.icon} text-4xl text-white"></i>
        </div>
        <h2 class="text-2xl font-bold mb-3">${step.title}</h2>
        <p class="text-gray-600 mb-6">${step.desc}</p>
        <div class="flex gap-3 justify-center">
            ${onboardingStep < onboardingSteps.length - 1 ? `
                <button onclick="skipOnboarding()" class="px-4 py-2 text-gray-500 hover:text-gray-700">Skip</button>
                <button onclick="nextOnboardingStep()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800">Next</button>
            ` : `
                <button onclick="finishOnboarding()" class="px-6 py-2 bg-black text-white rounded-lg hover:bg-gray-800">Get Started</button>
            `}
        </div>
    `;
    // Update dots
    document.getElementById('onboarding-dots').innerHTML = onboardingSteps.map((_, i) => 
        `<div class="w-2 h-2 rounded-full ${i === onboardingStep ? 'bg-black' : 'bg-gray-300'}"></div>`
    ).join('');
}

function nextOnboardingStep() {
    onboardingStep++;
    renderOnboardingStep();
}

function skipOnboarding() { finishOnboarding(); }

function finishOnboarding() {
    state.onboardingComplete = true;
    saveState();
    document.getElementById('onboarding-overlay').classList.remove('active');
}

// =============================================
// INIT
// =============================================
document.addEventListener('DOMContentLoaded', () => {
    // Apply theme
    if (state.settings.ui.darkMode) {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('toggle-dark-mode').checked = true;
    }

    // Apply preset - remove default and set saved preset
    document.querySelectorAll('[id^="preset-"]').forEach(el => {
        el.classList.remove('border-black');
        el.classList.add('border-gray-200');
    });
    const savedPreset = document.getElementById(`preset-${state.settings.scanPreset}`);
    if (savedPreset) {
        savedPreset.classList.remove('border-gray-200');
        savedPreset.classList.add('border-black');
    }

    // Apply other settings
    document.getElementById('toggle-realtime').checked = state.settings.ui.realtime !== false;
    document.getElementById('toggle-comparison').checked = state.settings.ui.comparison || false;

    // Show onboarding for new users
    if (!state.onboardingComplete) {
        setTimeout(showOnboarding, 500);
    }

    // Load initial view
    router('dashboard');
});
</script>
</body>
</html>
